<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SiteLog AI ‚Äî Daily Report</title>
<meta name="description" content="AI-powered construction daily report">
<!-- PWA manifest inline -->
<link rel="manifest" href="data:application/json,{%22name%22:%22SiteLog+AI%22,%22short_name%22:%22SiteLog%22,%22display%22:%22standalone%22,%22background_color%22:%22%230F0F0F%22,%22theme_color%22:%22%23F5C518%22}">
<meta name="theme-color" content="#F5C518">
<!-- exifr full build: reads GPS + date metadata from gallery photos (pure browser, no server) -->
<script src="https://cdn.jsdelivr.net/npm/exifr@7/dist/full.umd.js"></script>
<!-- Tesseract.js: on-device OCR for VIN scanning ‚Äî runs locally, no internet needed after first load -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');
:root{--y:#F5C518;--or:#E8631A;--dk:#0F0F0F;--dk2:#1A1A1A;--dk3:#252525;--dk4:#333;--lt:#F2EDE4;--mu:#888;--gr:#2ECC71;--rd:#E74C3C;--bl:#3498DB;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dk);color:var(--lt);font-family:'DM Sans',sans-serif;min-height:100vh;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:var(--dk2);border-bottom:2px solid var(--y);position:sticky;top:0;z-index:200;flex-wrap:wrap;gap:8px;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:3px;color:var(--y);}
.logo span{color:var(--lt);}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.date-badge{background:var(--dk3);border:1px solid var(--dk4);padding:5px 12px;border-radius:4px;font-family:'DM Mono',monospace;font-size:12px;color:var(--mu);}
.online-badge{padding:4px 10px;border-radius:100px;font-size:11px;font-weight:700;letter-spacing:.5px;}
.online-badge.online{background:rgba(46,204,113,.15);color:var(--gr);border:1px solid var(--gr);}
.online-badge.offline{background:rgba(231,76,60,.15);color:var(--rd);border:1px solid var(--rd);}
.gps-badge{padding:4px 10px;border-radius:100px;font-size:11px;font-weight:600;background:rgba(52,152,219,.12);color:var(--bl);border:1px solid var(--bl);cursor:pointer;}

/* LAYOUT */
.container{max-width:1100px;margin:0 auto;padding:24px 20px 80px;}

/* SECTION TITLES */
.sec-title{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--y);margin-bottom:4px;}
.sec-sub{font-size:12px;color:var(--mu);margin-bottom:16px;}

/* CARDS / PANELS */
.panel{background:var(--dk2);border:1.5px solid var(--dk3);border-radius:10px;padding:20px;margin-bottom:20px;}
.panel.yellow-border{border-color:var(--y);}

/* BUTTONS */
.btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;transition:all .15s;}
.btn-y{background:var(--y);color:var(--dk);}
.btn-y:hover{background:#dba800;transform:translateY(-1px);}
.btn-y:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-ghost{background:var(--dk3);color:var(--lt);border:1.5px solid var(--dk4);}
.btn-ghost:hover{border-color:var(--y);}
.btn-or{background:var(--or);color:#fff;}
.btn-or:hover{background:#c8541a;}
.btn-gr{background:transparent;color:var(--gr);border:1.5px solid var(--gr);}
.btn-gr:hover{background:rgba(46,204,113,.1);}
.btn-red{background:transparent;color:var(--rd);border:1.5px solid var(--rd);padding:5px 10px;font-size:12px;}
.btn-red:hover{background:rgba(231,76,60,.1);}
.btn-sm{padding:6px 12px;font-size:12px;}

/* INPUTS */
.field-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--mu);margin-bottom:5px;}
input[type=text],input[type=email],input[type=number],input[type=date],input[type=password],select,textarea{
  background:var(--dk3);border:1.5px solid var(--dk4);border-radius:6px;color:var(--lt);
  font-family:'DM Sans',sans-serif;font-size:13px;padding:9px 12px;outline:none;width:100%;transition:border-color .2s;}
input:focus,select:focus,textarea:focus{border-color:var(--y);}
select option{background:var(--dk2);}
textarea{resize:vertical;}

/* GRID HELPERS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
@media(max-width:700px){.g2,.g3,.g4{grid-template-columns:1fr 1fr;}.g-solo{grid-template-columns:1fr;}}
@media(max-width:480px){.g2,.g3,.g4{grid-template-columns:1fr;}}

/* FIELD CARD */
.fc{background:var(--dk2);border:1.5px solid var(--dk3);border-radius:8px;padding:12px 14px;}
.fc:focus-within{border-color:var(--y);}
.fc input,.fc select{background:transparent;border:none;padding:0;font-size:14px;}
.fc input:focus,.fc select:focus{border:none;outline:none;}

/* WEATHER BUTTONS */
.weather-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
.wc{padding:5px 12px;border:1.5px solid var(--dk4);border-radius:100px;background:transparent;color:var(--mu);font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;}
.wc:hover,.wc.active{border-color:var(--y);color:var(--y);background:rgba(245,197,24,.07);}

/* VOICE / NOTES */
.voice-hero{background:linear-gradient(135deg,#1e1400,#0f0f0f);border:1.5px solid var(--y);border-radius:12px;padding:28px;margin-bottom:20px;position:relative;overflow:hidden;}
.voice-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:160px;height:160px;background:var(--y);opacity:.04;border-radius:50%;}
.vt{font-family:'Bebas Neue',sans-serif;font-size:34px;letter-spacing:2px;color:var(--y);margin-bottom:4px;}
.vs{color:var(--mu);font-size:13px;margin-bottom:20px;}
.voice-area{background:var(--dk3);border:1.5px solid var(--dk4);border-radius:8px;padding:14px;margin-bottom:14px;}
.voice-area:focus-within{border-color:var(--y);}
.voice-area textarea{background:transparent;border:none;padding:0;width:100%;min-height:100px;line-height:1.6;font-size:14px;}
.voice-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.mic-dot{width:7px;height:7px;background:#fff;border-radius:50%;}
.btn-rec{display:flex;align-items:center;gap:7px;}
.btn-rec.recording{background:var(--rd);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,.4);}50%{box-shadow:0 0 0 8px rgba(231,76,60,0);}}
.hint-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px;}
.hc{background:var(--dk3);border:1px solid var(--dk4);padding:4px 10px;border-radius:100px;font-size:11px;color:var(--mu);cursor:pointer;transition:all .15s;}
.hc:hover{border-color:var(--y);color:var(--y);}

/* LANGUAGE SELECTOR */
.lang-pills{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;}
.lp{padding:5px 14px;border:1.5px solid var(--dk4);border-radius:100px;background:transparent;color:var(--mu);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;transition:all .15s;}
.lp:hover,.lp.active{border-color:var(--y);color:var(--y);background:rgba(245,197,24,.07);}

/* EQUIPMENT TABLE */
.eq-row{display:grid;grid-template-columns:80px 1fr 80px 1fr 1fr 1fr 90px 36px;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--dk3);}
.eq-row:last-child{border-bottom:none;}
.eq-header{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--mu);padding:4px 0 8px;border-bottom:1px solid var(--dk4);}
.eq-row input,.eq-row select{background:var(--dk3);border:1px solid var(--dk4);padding:7px 9px;border-radius:5px;font-size:12px;}
.eq-row input:focus,.eq-row select:focus{border-color:var(--y);}
.idle-time-input{display:flex;align-items:center;gap:4px;}
.idle-time-input input{width:55px;}
.idle-time-input span{font-size:11px;color:var(--mu);}
@media(max-width:900px){.eq-row{grid-template-columns:1fr 1fr;gap:6px;background:var(--dk3);border-radius:8px;padding:10px;margin-bottom:8px;border-bottom:none;}}

/* LABOR TABLE */
.lb-row{display:grid;grid-template-columns:1fr 1fr 120px 36px;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--dk3);}
.lb-row:last-child{border-bottom:none;}
.lb-row input,.lb-row select{background:var(--dk3);border:1px solid var(--dk4);padding:7px 9px;border-radius:5px;font-size:12px;}
.lb-row input:focus,.lb-row select:focus{border-color:var(--y);}
@media(max-width:600px){.lb-row{grid-template-columns:1fr 1fr;gap:6px;background:var(--dk3);border-radius:8px;padding:10px;margin-bottom:8px;border-bottom:none;}}

/* PHOTO */
.photo-drop{border:2px dashed var(--dk4);border-radius:10px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px;}
.photo-drop:hover,.photo-drop.drag-over{border-color:var(--y);background:rgba(245,197,24,.03);}
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}
.photo-card{background:var(--dk3);border:1.5px solid var(--dk4);border-radius:8px;overflow:hidden;position:relative;transition:border-color .2s;}
.photo-card:hover{border-color:var(--y);}
.photo-card img{width:100%;height:130px;object-fit:cover;display:block;}
.photo-card-body{padding:8px 10px;}
.photo-card-body textarea{background:transparent;border:none;padding:0;font-size:11px;min-height:40px;line-height:1.4;}
.photo-card-foot{display:flex;align-items:center;justify-content:space-between;padding:4px 10px 8px;gap:4px;}
.photo-cat{font-size:11px;padding:3px 6px;border:1px solid var(--dk4);border-radius:4px;background:transparent;color:var(--mu);}
.photo-ai-btn{font-size:10px;padding:3px 8px;border:1px solid var(--or);border-radius:100px;background:transparent;color:var(--or);cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;}
.photo-ai-btn:hover{background:rgba(232,99,26,.1);}
.photo-remove{position:absolute;top:5px;right:5px;width:20px;height:20px;background:rgba(0,0,0,.7);border:none;border-radius:50%;color:#aaa;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.photo-remove:hover{background:var(--rd);color:#fff;}
.ai-done-badge{position:absolute;top:5px;left:5px;background:var(--or);color:#fff;font-size:9px;font-weight:700;padding:2px 5px;border-radius:3px;display:none;}
.ai-done-badge.show{display:block;}

/* SECTIONS TOGGLE */
.tog-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.tog{background:var(--dk2);border:1.5px solid var(--dk3);border-radius:8px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .15s;font-size:13px;font-weight:500;}
.tog:hover,.tog.active{border-color:var(--y);}
.tog.active{background:rgba(245,197,24,.06);}
.tog-box{width:18px;height:18px;border:2px solid var(--dk4);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;}
.tog.active .tog-box{background:var(--y);border-color:var(--y);color:var(--dk);}
.tog-desc{font-size:11px;color:var(--mu);margin-top:1px;}

/* SIGNATURE */
.sig-area{background:var(--dk3);border:2px solid var(--dk4);border-radius:8px;cursor:crosshair;display:block;touch-action:none;}
.sig-controls{display:flex;gap:8px;margin-top:8px;align-items:center;}
.sig-label{font-size:12px;color:var(--mu);margin-bottom:6px;}
.sig-name-input{background:var(--dk3);border:1px solid var(--dk4);border-radius:5px;padding:6px 10px;font-size:12px;color:var(--lt);font-family:'DM Sans',sans-serif;outline:none;width:100%;margin-bottom:8px;}
.sig-name-input:focus{border-color:var(--y);}

/* STATUS BAR */
.status-bar{display:none;align-items:center;gap:10px;padding:11px 16px;background:var(--dk3);border-radius:8px;margin-bottom:16px;font-size:13px;color:var(--mu);}
.status-bar.show{display:flex;}
.spinner{width:14px;height:14px;border:2px solid var(--dk4);border-top-color:var(--y);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg);}}

/* REPORT OUTPUT */
.report-out{background:var(--dk2);border:1.5px solid var(--dk3);border-radius:12px;overflow:hidden;margin-bottom:20px;display:none;}
.report-out.show{display:block;}
.report-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--dk3);border-bottom:1px solid var(--dk4);flex-wrap:wrap;gap:8px;}
.report-title{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1.5px;color:var(--y);}
.report-actions{display:flex;gap:6px;flex-wrap:wrap;}
.report-body{padding:18px;}
.report-text{font-family:'DM Mono',monospace;font-size:12px;line-height:1.8;color:var(--lt);white-space:pre-wrap;}

/* OFFLINE BANNER */
.offline-banner{background:rgba(231,76,60,.1);border:1px solid var(--rd);border-radius:8px;padding:10px 16px;font-size:13px;color:var(--rd);margin-bottom:16px;display:none;}
.offline-banner.show{display:block;}
.queue-badge{background:var(--or);color:#fff;border-radius:100px;padding:2px 8px;font-size:11px;font-weight:700;margin-left:6px;}

/* WARN */
.warn{background:rgba(232,99,26,.1);border:1px solid var(--or);border-radius:8px;padding:12px 16px;font-size:13px;color:var(--or);margin-bottom:16px;display:none;}
.warn.show{display:block;}

/* GPS COORDS */
.gps-display{font-family:'DM Mono',monospace;font-size:12px;color:var(--bl);}

/* WIND */
.wind-auto{font-family:'DM Mono',monospace;font-size:12px;color:var(--gr);margin-top:4px;}

/* OFFLINE INDICATOR DOT */
.saved-dot{width:7px;height:7px;border-radius:50%;background:var(--gr);display:inline-block;margin-right:5px;}

/* REPORT CHOICE MODAL */
.choice-modal{background:var(--dk2);border:1.5px solid var(--y);border-radius:14px;padding:32px 28px;max-width:500px;width:92%;max-height:92vh;overflow-y:auto;}
.choice-modal h3{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px;color:var(--y);margin-bottom:6px;}
.choice-modal p{font-size:13px;color:var(--mu);margin-bottom:24px;line-height:1.5;}
.choice-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
@media(max-width:480px){.choice-cards{grid-template-columns:1fr;}}
.choice-card{background:var(--dk3);border:2px solid var(--dk4);border-radius:10px;padding:20px 16px;cursor:pointer;text-align:center;transition:all .18s;position:relative;}
.choice-card:hover{border-color:var(--y);background:rgba(245,197,24,.05);transform:translateY(-2px);}
.choice-card.ai-card:hover{border-color:var(--or);}
.choice-card .card-icon{font-size:36px;margin-bottom:10px;display:block;}
.choice-card .card-title{font-family:'Bebas Neue',sans-serif;font-size:19px;letter-spacing:1.5px;color:var(--lt);margin-bottom:6px;}
.choice-card .card-desc{font-size:11px;color:var(--mu);line-height:1.5;}
.choice-card .card-badge{position:absolute;top:-8px;right:10px;background:var(--or);color:#fff;font-size:9px;font-weight:700;padding:2px 8px;border-radius:100px;letter-spacing:.5px;}
.choice-card.ai-card .card-title{color:var(--y);}
.choice-dismiss{font-size:12px;color:var(--mu);text-align:center;cursor:pointer;text-decoration:underline;}
.choice-dismiss:hover{color:var(--lt);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:999;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.show{display:flex;}
.modal{background:var(--dk2);border:1.5px solid var(--y);border-radius:12px;padding:28px;max-width:440px;width:90%;max-height:85vh;overflow-y:auto;}
.modal h3{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--y);margin-bottom:16px;letter-spacing:1.5px;}

/* DIVIDER */
.divider{height:1px;background:var(--dk3);margin:24px 0;}

/* REPORT LOGOS */
.logo-slots{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;}
.logo-slot{border:2px dashed var(--dk4);border-radius:8px;height:72px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;background:var(--dk3);}
.logo-slot:hover{border-color:var(--y);background:rgba(245,197,24,.04);}
.logo-slot img{width:100%;height:100%;object-fit:contain;padding:6px;}
.logo-slot-label{font-size:10px;color:var(--mu);text-align:center;line-height:1.4;pointer-events:none;}
.logo-slot-remove{position:absolute;top:3px;right:3px;width:18px;height:18px;background:rgba(231,76,60,.85);border:none;border-radius:50%;color:#fff;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:2;}
.logo-slot:hover .logo-slot-remove{display:flex;}

/* VIN SCAN */
.vin-actions{display:flex;gap:5px;align-items:center;flex-wrap:wrap;}
.mic-btn{background:transparent;border:1px solid var(--dk4);border-radius:100px;color:var(--mu);font-size:11px;padding:2px 7px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;line-height:1.4;transition:all .15s;white-space:nowrap;}
.mic-btn:hover{border-color:var(--or);color:var(--or);}
.mic-btn.active{border-color:var(--rd);color:var(--rd);background:rgba(231,76,60,.1);animation:pulse .9s infinite;}
.field-row{display:flex;align-items:center;gap:5px;}
.field-row input{flex:1;min-width:0;}

/* TEMPLATE MODAL */
.tpl-modal{background:var(--dk2);border:1.5px solid var(--y);border-radius:12px;padding:24px 22px;max-width:400px;width:92%;max-height:82vh;overflow-y:auto;}
.tpl-modal h3{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--y);margin-bottom:4px;letter-spacing:1.5px;}
.tpl-modal p{font-size:12px;color:var(--mu);margin-bottom:18px;}
.tpl-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
.tpl-item{display:flex;align-items:center;gap:8px;background:var(--dk3);border:1.5px solid var(--dk4);border-radius:8px;padding:10px 12px;}
.tpl-item-name{flex:1;font-size:13px;font-weight:500;color:var(--lt);}
.tpl-item-meta{font-size:11px;color:var(--mu);}
.tpl-empty{font-size:13px;color:var(--mu);text-align:center;padding:20px 0;}

@media(max-width:600px){
  .tog-grid{grid-template-columns:1fr;}
  header{padding:12px 16px;}
}
</style>
</head>
<body>

<header>
  <div class="logo">SiteLog<span> AI</span></div>
  <div class="header-right">
    <div class="gps-badge" id="gpsBadge" onclick="refreshGPS()">üìç Getting GPS...</div>
    <div class="online-badge offline" id="onlineBadge">‚óè OFFLINE</div>
    <div class="date-badge" id="dateBadge"></div>
  </div>
</header>

<!-- OFFLINE BANNER -->
<div class="container">
<div class="offline-banner" id="offlineBanner">
  ‚ö° You are offline. All data is saved locally on this device. Report will be generated &amp; emailed automatically when internet is restored.
  <span class="queue-badge" id="queueBadge" style="display:none;">0 queued</span>
</div>

<!-- WARN -->
<div class="warn" id="noKeyWarn">‚ö† No API key set. Enter your Anthropic API key to enable AI.</div>

<!-- API KEY -->
<div class="panel">
  <div class="sec-title">Configuration</div>
  <div class="g2" style="margin-bottom:10px;">
    <div>
      <div class="field-label">Anthropic API Key</div>
      <input type="password" id="apiKey" placeholder="sk-ant-...">
    </div>
    <div>
      <div class="field-label">Email Report To</div>
      <input type="email" id="emailTo" placeholder="engineer@company.com">
    </div>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <button class="btn btn-y btn-sm" onclick="saveConfig()">üíæ Save Config</button>
    <button class="btn btn-ghost btn-sm" onclick="loadSavedDraft()">üìÇ Load Saved Draft</button>
    <button class="btn btn-red btn-sm" onclick="clearDraft()">üóë Clear Draft</button>
  </div>
  <div style="margin-top:8px;font-size:11px;color:var(--mu);">
    <span class="saved-dot" id="savedDot" style="background:var(--mu)"></span>
    <span id="savedStatus">No draft saved</span>
  </div>
</div>

<!-- PROJECT INFO -->
<div class="panel">
  <div class="sec-title">Project Info</div>
  <div class="g4" style="margin-bottom:12px;">
    <div class="fc">
      <div class="field-label">Project Name</div>
      <input type="text" id="project" placeholder="Tower Block A" oninput="autosave()">
    </div>
    <div class="fc">
      <div class="field-label">Engineer Name</div>
      <input type="text" id="engineer" placeholder="Full name" oninput="autosave()">
    </div>
    <div class="fc">
      <div class="field-label">Report Date</div>
      <input type="date" id="reportDate" oninput="autosave()">
    </div>
    <div class="fc">
      <div class="field-label">Overall Progress %</div>
      <input type="number" id="progress" min="0" max="100" placeholder="42" oninput="autosave()">
    </div>
    <div class="fc">
      <div class="field-label">Workers on Site</div>
      <input type="number" id="workers" placeholder="24" oninput="autosave()">
    </div>
    <div class="fc">
      <div class="field-label">Shift</div>
      <select id="shift" onchange="autosave()">
        <option value="Day">Day Shift</option>
        <option value="Night">Night Shift</option>
        <option value="Full">Full Day</option>
      </select>
    </div>
    <div class="fc" style="grid-column:span 2;">
      <div class="field-label">GPS Location</div>
      <div class="gps-display" id="gpsDisplay">Acquiring coordinates...</div>
    </div>
  </div>

  <!-- REPORT LOGOS -->
  <div style="margin-top:16px;border-top:1px solid var(--dk3);padding-top:14px;">
    <div class="field-label" style="margin-bottom:8px;">Report Header Logos <span style="color:var(--mu);font-weight:400;text-transform:none;letter-spacing:0;">(tap a slot to upload ¬∑ max 120√ó60px in report)</span></div>
    <div class="logo-slots">
      <div>
        <div style="font-size:10px;color:var(--mu);margin-bottom:4px;text-align:center;">Left (Owner)</div>
        <div class="logo-slot" id="logoSlot-left" onclick="pickLogo('left')" title="Tap to upload owner logo">
          <div class="logo-slot-label">Ôºã<br>Owner Logo</div>
          <button class="logo-slot-remove" id="logoRemove-left" onclick="event.stopPropagation();removeLogo('left')">√ó</button>
        </div>
      </div>
      <div>
        <div style="font-size:10px;color:var(--mu);margin-bottom:4px;text-align:center;">Center (Project)</div>
        <div class="logo-slot" id="logoSlot-center" onclick="pickLogo('center')" title="Tap to upload project/agency logo">
          <div class="logo-slot-label">Ôºã<br>Project Logo</div>
          <button class="logo-slot-remove" id="logoRemove-center" onclick="event.stopPropagation();removeLogo('center')">√ó</button>
        </div>
      </div>
      <div>
        <div style="font-size:10px;color:var(--mu);margin-bottom:4px;text-align:center;">Right (Contractor)</div>
        <div class="logo-slot" id="logoSlot-right" onclick="pickLogo('right')" title="Tap to upload contractor logo">
          <div class="logo-slot-label">Ôºã<br>Contractor Logo</div>
          <button class="logo-slot-remove" id="logoRemove-right" onclick="event.stopPropagation();removeLogo('right')">√ó</button>
        </div>
      </div>
    </div>
    <!-- Hidden file input shared by all three slots -->
    <input type="file" id="logoFileInput" accept="image/*" style="display:none" onchange="handleLogoUpload(this.files)">
  </div>
  <div class="field-label">Weather</div>
  <div class="weather-chips">
    <button class="wc" onclick="setWeather(this,'‚òÄ Sunny')">‚òÄ Sunny</button>
    <button class="wc" onclick="setWeather(this,'‚õÖ Partly Cloudy')">‚õÖ Cloudy</button>
    <button class="wc" onclick="setWeather(this,'üåß Rainy')">üåß Rainy</button>
    <button class="wc" onclick="setWeather(this,'üå© Storm')">üå© Storm</button>
    <button class="wc" onclick="setWeather(this,'üå¨ Windy')">üå¨ Windy</button>
    <button class="wc" onclick="setWeather(this,'‚ùÑ Cold')">‚ùÑ Cold</button>
  </div>
  <div style="margin-top:10px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
    <div>
      <div class="field-label" style="margin-bottom:3px;">Wind Speed</div>
      <div style="display:flex;align-items:center;gap:6px;">
        <input type="number" id="windSpeed" placeholder="‚Äî" style="width:80px;" oninput="autosave()">
        <span style="font-size:12px;color:var(--mu);">mph</span>
        <button class="btn btn-ghost btn-sm" onclick="fetchWind()" style="font-size:11px;padding:5px 10px;">üå¨ Auto-fetch</button>
      </div>
      <div class="wind-auto" id="windAuto"></div>
    </div>
    <div>
      <div class="field-label" style="margin-bottom:3px;">Temperature</div>
      <div style="display:flex;align-items:center;gap:6px;">
        <input type="number" id="temp" placeholder="‚Äî" style="width:70px;" oninput="autosave()">
        <span style="font-size:12px;color:var(--mu);">¬∞F</span>
      </div>
    </div>
  </div>
</div>

<!-- EQUIPMENT LOG -->
<div class="panel">
  <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:4px;">
    <div class="sec-title">Equipment Log</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn btn-ghost btn-sm" onclick="saveEqTemplate()" title="Save current equipment as a reusable template">üíæ Save Template</button>
      <button class="btn btn-ghost btn-sm" onclick="openEqTemplates()" title="Load a saved equipment template">üìã Load Template</button>
    </div>
  </div>
  <div class="sec-sub">Required for accident reporting compliance. All equipment must be logged.</div>

  <div id="eqList"></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
    <button class="btn btn-ghost btn-sm" onclick="addEquipment()">Ôºã Add Equipment</button>
    <button class="btn btn-ghost btn-sm" onclick="addEquipment(true)">üöõ Add Vehicle</button>
  </div>
</div>

<!-- LABOR LOG -->
<div class="panel">
  <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:4px;">
    <div class="sec-title">Labor Compliance Log</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn btn-ghost btn-sm" onclick="saveCrewTemplate()" title="Save current crew as a reusable template">üíæ Save Template</button>
      <button class="btn btn-ghost btn-sm" onclick="openCrewTemplates()" title="Load a saved crew template">üìã Load Template</button>
    </div>
  </div>
  <div class="sec-sub">Legal names and roles required for labor compliance. Use camera to scan ID cards.</div>

  <div id="laborList"></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
    <button class="btn btn-ghost btn-sm" onclick="addLabor()">Ôºã Add Worker</button>
    <button class="btn btn-or btn-sm" onclick="addLaborBulk()">‚ö° Bulk Add (paste list)</button>
  </div>
</div>

<!-- SITE NOTES (AI voice) -->
<div class="voice-hero">
  <div class="vt">Today's Site Notes</div>
  <div class="vs">Tap üéô to record ‚Äî text appears live as you speak. Or type rough notes in any language.</div>

  <!-- Language selector -->
  <div style="margin-bottom:12px;">
    <div style="font-size:11px;color:var(--mu);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">Input Language</div>
    <div class="lang-pills">
      <button class="lp active" onclick="setLang(this,'en')" data-lang="en">üá∫üá∏ English</button>
      <button class="lp" onclick="setLang(this,'es')" data-lang="es">üá™üá∏ Espa√±ol</button>
      <button class="lp" onclick="setLang(this,'zh')" data-lang="zh">üá®üá≥ ‰∏≠Êñá</button>
      <button class="lp" onclick="setLang(this,'vi')" data-lang="vi">üáªüá≥ Ti·∫øng Vi·ªát</button>
    </div>
  </div>

  <div class="voice-area">
    <textarea id="voiceText" placeholder="Tap üéô Record Voice ‚Äî words appear here live as you speak. Or type rough notes here. e.g. Poured 40m¬≥ concrete on columns C1-C8, done at noon. 2hr delay ‚Äî mixer broke..." oninput="autosave()"></textarea>
  </div>

  <div class="voice-controls">
    <button class="btn btn-or btn-rec" id="recordBtn" onclick="toggleRecord()">
      <div class="mic-dot"></div> Record Voice
    </button>
    <button class="btn btn-y" id="generateBtn" onclick="openGenerateModal()">‚ö° Generate Full Report</button>
    <button class="btn btn-ghost" onclick="clearNotes()">Clear</button>
  </div>

  <div class="hint-chips">
    <span class="hc" onclick="addHint('Poured concrete on ')"># Concrete pour</span>
    <span class="hc" onclick="addHint('Safety incident: ')"># Safety</span>
    <span class="hc" onclick="addHint('Delay caused by ')"># Delay</span>
    <span class="hc" onclick="addHint('Inspection by ')"># Inspection</span>
    <span class="hc" onclick="addHint('Materials delivered: ')"># Materials</span>
    <span class="hc" onclick="addHint('RFI submitted for ')"># RFI</span>
    <span class="hc" onclick="addHint('Tomorrow we plan to ')"># Plan</span>
  </div>
</div>

<!-- REPORT SECTIONS -->
<div style="margin-bottom:10px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--mu);">Include in Report</div>
<div class="tog-grid" style="margin-bottom:20px;">
  <div class="tog active" id="tog-work" onclick="togSection('work')"><div class="tog-box">‚úì</div><div><div>Work Completed</div><div class="tog-desc">Tasks, quantities, locations</div></div></div>
  <div class="tog active" id="tog-safety" onclick="togSection('safety')"><div class="tog-box">‚úì</div><div><div>Safety &amp; HSE</div><div class="tog-desc">Incidents, PPE, observations</div></div></div>
  <div class="tog active" id="tog-resources" onclick="togSection('resources')"><div class="tog-box">‚úì</div><div><div>Resources &amp; Equipment</div><div class="tog-desc">Labor, machinery, materials</div></div></div>
  <div class="tog active" id="tog-delays" onclick="togSection('delays')"><div class="tog-box">‚úì</div><div><div>Delays &amp; Issues</div><div class="tog-desc">Blockers, RFIs, changes</div></div></div>
  <div class="tog active" id="tog-quality" onclick="togSection('quality')"><div class="tog-box">‚úì</div><div><div>Quality &amp; Inspections</div><div class="tog-desc">Tests, checkpoints, sign-offs</div></div></div>
  <div class="tog active" id="tog-plan" onclick="togSection('plan')"><div class="tog-box">‚úì</div><div><div>Plan for Tomorrow</div><div class="tog-desc">Next day schedule</div></div></div>
</div>

<!-- PHOTOS -->
<div class="panel">
  <div class="sec-title">üì∏ Site Photos</div>
  <div class="sec-sub">Voice-caption each photo ‚Äî tap üéô Speak on any photo and dictate the caption live.</div>
  <div class="photo-drop" id="photoDropZone" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="event.preventDefault();this.classList.remove('drag-over');handlePhotos(event.dataTransfer.files)">
    <div style="font-size:32px;margin-bottom:10px;">üì∑</div>
    <div style="color:var(--mu);font-size:13px;margin-bottom:14px;">Drag &amp; drop photos here, or use the buttons below</div>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button class="btn btn-y btn-sm" onclick="takePhotoWithGPS()" style="gap:6px;">üì∑ Take Photo</button>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('photoGallery').click()">üñº Choose from Gallery</button>
    </div>
    <!-- Camera only ‚Äî opened programmatically after GPS acquired -->
    <input type="file" id="photoCamera" accept="image/*" capture="environment" style="display:none" onchange="handleCameraPhoto(this.files)">
    <!-- Gallery only ‚Äî EXIF metadata extracted per file -->
    <input type="file" id="photoGallery" accept="image/*" multiple style="display:none" onchange="handleGalleryPhotos(this.files)">
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
    <span id="photoStats" style="font-size:12px;color:var(--mu);">No photos</span>
    <button class="btn btn-or btn-sm" id="aiAllBtn" style="display:none;" onclick="captionAll()">‚ö° AI Caption All</button>
  </div>
  <div class="photo-grid" id="photoGrid"></div>
</div>

<!-- SIGNATURES -->
<div class="panel">
  <div class="sec-title">‚úç Daily Sign-Off Signatures</div>
  <div class="sec-sub">Both parties must sign at end of each shift.</div>
  <div class="g2">
    <!-- Inspector -->
    <div>
      <div style="font-size:12px;font-weight:700;color:var(--y);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Owner / Field Inspector</div>
      <input class="sig-name-input" id="inspectorName" placeholder="Inspector full name" oninput="autosave()">
      <canvas class="sig-area" id="canvasInspector" width="400" height="130"></canvas>
      <div class="sig-controls">
        <button class="btn btn-ghost btn-sm" onclick="clearSig('Inspector')">Clear</button>
        <span style="font-size:11px;color:var(--mu);" id="sigStatusInspector">Not signed</span>
      </div>
    </div>
    <!-- Superintendent -->
    <div>
      <div style="font-size:12px;font-weight:700;color:var(--y);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Contractor Superintendent</div>
      <input class="sig-name-input" id="superintendentName" placeholder="Superintendent full name" oninput="autosave()">
      <canvas class="sig-area" id="canvasSuperintendent" width="400" height="130"></canvas>
      <div class="sig-controls">
        <button class="btn btn-ghost btn-sm" onclick="clearSig('Superintendent')">Clear</button>
        <span style="font-size:11px;color:var(--mu);" id="sigStatusSuperintendent">Not signed</span>
      </div>
    </div>
  </div>
</div>

<!-- STATUS -->
<div class="status-bar" id="statusBar">
  <div class="spinner"></div>
  <span id="statusText">Processing...</span>
</div>

<!-- REPORT OUTPUT -->
<div class="report-out" id="reportOut">
  <div class="report-head">
    <div class="report-title">Generated Report</div>
    <div class="report-actions">
      <button class="btn btn-ghost btn-sm" onclick="openGenerateModal()">‚Ü∫ Regenerate</button>
      <button class="btn btn-gr btn-sm" onclick="copyReport()">‚éò Copy Text</button>
      <button class="btn btn-gr btn-sm" onclick="downloadReport()">‚Üì Download</button>
      <button class="btn btn-y btn-sm" onclick="sendEmail()">‚úâ Send Email</button>
    </div>
  </div>
  <div class="report-body">
    <div id="reportLogoBar" style="display:none;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--dk4);"></div>
    <div class="report-text" id="reportContent"></div>
    <div id="reportPhotoArea"></div>
    <div id="reportSigArea" style="margin-top:20px;"></div>
  </div>
</div>

</div><!-- /container -->

<!-- CREW TEMPLATE MODAL -->
<div class="modal-overlay" id="crewTplModal">
  <div class="tpl-modal">
    <h3>üë∑ Crew Templates</h3>
    <p>Save today's crew roster and reload it on future shifts ‚Äî one tap fills all workers.</p>
    <div id="crewTplList" class="tpl-list"></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn btn-ghost btn-sm" style="flex:1;" onclick="document.getElementById('crewTplModal').classList.remove('show')">Close</button>
    </div>
  </div>
</div>

<!-- EQUIPMENT TEMPLATE MODAL -->
<div class="modal-overlay" id="eqTplModal">
  <div class="tpl-modal">
    <h3>üöõ Equipment Templates</h3>
    <p>Save your site's standing equipment roster and reload it each shift with one tap.</p>
    <div id="eqTplList" class="tpl-list"></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn btn-ghost btn-sm" style="flex:1;" onclick="document.getElementById('eqTplModal').classList.remove('show')">Close</button>
    </div>
  </div>
</div>

<!-- REPORT TYPE CHOICE MODAL -->
<div class="modal-overlay" id="choiceModal">
  <div class="choice-modal">
    <h3>Generate Report</h3>
    <p>Choose how to generate your daily report. Both options will email the report to the address you configured.</p>
    <div class="choice-cards">

      <!-- Plain / As-Filled -->
      <div class="choice-card" onclick="generatePlainReport()">
        <span class="card-icon">üìã</span>
        <div class="card-title">As-Filled Report</div>
        <div class="card-desc">Compiles all your entries exactly as entered into a structured, professionally formatted report.<br><br>‚úÖ No API key needed<br>‚úÖ Works offline<br>‚úÖ Instant ‚Äî no wait</div>
      </div>

      <!-- AI-Generated -->
      <div class="choice-card ai-card" onclick="generateAIReport()">
        <span class="card-badge">AI POWERED</span>
        <span class="card-icon">‚ö°</span>
        <div class="card-title">AI Professional Report</div>
        <div class="card-desc">Claude AI rewrites your rough notes into formal construction language with full narrative sections.<br><br>‚ö° Requires API key<br>‚ö° Requires internet<br>‚ö° ~10 seconds</div>
      </div>

    </div>
    <div class="choice-dismiss" onclick="document.getElementById('choiceModal').classList.remove('show')">Cancel ‚Äî go back</div>
  </div>
</div>

<!-- BULK LABOR MODAL -->
<div class="modal-overlay" id="bulkModal">
  <div class="modal">
    <h3>Bulk Add Workers</h3>
    <p style="font-size:13px;color:var(--mu);margin-bottom:12px;">Paste a list, one worker per line in format:<br><code style="color:var(--y);">Full Name, Role</code><br>e.g. <em>John Martinez, Ironworker</em></p>
    <textarea id="bulkText" style="min-height:140px;margin-bottom:12px;" placeholder="John Martinez, Ironworker&#10;Maria Nguyen, Electrician&#10;Wei Chen, Carpenter"></textarea>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-y" onclick="processBulkLabor()">Add Workers</button>
      <button class="btn btn-ghost" onclick="document.getElementById('bulkModal').classList.remove('show')">Cancel</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let apiKey = '';
let emailTo = '';
let weatherVal = '';
let inputLang = 'en';
let selectedSections = new Set(['work','safety','resources','delays','quality','plan']);
let photos = [];
let photoCounter = 0;
let equipmentList = [];
let laborList = [];
let gpsCoords = null;
let isRecording = false;
let offlineQueue = [];
let autosaveTimer = null;
let sigData = { Inspector: null, Superintendent: null };
let reportLogos = { left: null, center: null, right: null };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const now = new Date();
document.getElementById('dateBadge').textContent = now.toDateString();
document.getElementById('reportDate').value = now.toISOString().split('T')[0];

// Load saved config
window.addEventListener('DOMContentLoaded', function(){
  const cfg = JSON.parse(localStorage.getItem('sitelog_config') || '{}');
  if(cfg.apiKey){ apiKey = cfg.apiKey; document.getElementById('apiKey').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; }
  if(cfg.emailTo){ emailTo = cfg.emailTo; document.getElementById('emailTo').value = cfg.emailTo; }
  
  const draft = JSON.parse(localStorage.getItem('sitelog_draft') || 'null');
  if(draft){ 
    document.getElementById('savedStatus').textContent = 'Draft saved: ' + new Date(draft.ts).toLocaleString();
    document.getElementById('savedDot').style.background = 'var(--gr)';
  }
  
  const queue = JSON.parse(localStorage.getItem('sitelog_queue') || '[]');
  offlineQueue = queue;
  updateQueueBadge();
  
  // Start online monitor
  updateOnlineStatus();
  window.addEventListener('online', () => { updateOnlineStatus(); processQueue(); });
  window.addEventListener('offline', updateOnlineStatus);
  
  // GPS ‚Äî try immediately (works on Android); iOS needs user gesture so also wire the badge button
  getGPS();
  
  // Default equipment & labor rows
  addEquipment(false);
  addLabor();
  addLabor();
  
  // Setup signature canvases
  setupSig('Inspector');
  setupSig('Superintendent');
  
  // Photo drag/drop
  const dz = document.getElementById('photoDropZone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag-over'); handlePhotos(e.dataTransfer.files); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONLINE / OFFLINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateOnlineStatus(){
  const online = navigator.onLine;
  const badge = document.getElementById('onlineBadge');
  const banner = document.getElementById('offlineBanner');
  badge.className = 'online-badge ' + (online ? 'online' : 'offline');
  badge.textContent = online ? '‚óè ONLINE' : '‚óè OFFLINE';
  banner.classList.toggle('show', !online);
}

function updateQueueBadge(){
  const b = document.getElementById('queueBadge');
  if(offlineQueue.length > 0){
    b.style.display = 'inline';
    b.textContent = offlineQueue.length + ' queued';
  } else {
    b.style.display = 'none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTOSAVE (localStorage draft)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autosave(){
  clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(saveDraft, 1500);
}

function saveDraft(){
  const draft = {
    ts: Date.now(),
    project: v('project'), engineer: v('engineer'), reportDate: v('reportDate'),
    progress: v('progress'), workers: v('workers'), shift: v('shift'),
    weather: weatherVal, windSpeed: v('windSpeed'), temp: v('temp'),
    voiceText: v('voiceText'), inputLang,
    equipmentList, laborList,
    inspectorName: v('inspectorName'), superintendentName: v('superintendentName'),
    gpsCoords, reportLogos
  };
  localStorage.setItem('sitelog_draft', JSON.stringify(draft));
  document.getElementById('savedStatus').textContent = 'Auto-saved: ' + new Date().toLocaleTimeString();
  document.getElementById('savedDot').style.background = 'var(--gr)';
}

function loadSavedDraft(){
  const draft = JSON.parse(localStorage.getItem('sitelog_draft') || 'null');
  if(!draft){ alert('No saved draft found.'); return; }
  set('project', draft.project); set('engineer', draft.engineer);
  set('reportDate', draft.reportDate); set('progress', draft.progress);
  set('workers', draft.workers); set('shift', draft.shift);
  set('windSpeed', draft.windSpeed); set('temp', draft.temp);
  set('voiceText', draft.voiceText);
  set('inspectorName', draft.inspectorName || '');
  set('superintendentName', draft.superintendentName || '');
  if(draft.weather){ weatherVal = draft.weather; document.querySelectorAll('.wc').forEach(b=>{ if(b.textContent.trim()===draft.weather.trim()){b.classList.add('active');}else b.classList.remove('active'); }); }
  if(draft.gpsCoords) gpsCoords = draft.gpsCoords;
  if(draft.inputLang) setLangByCode(draft.inputLang);
  // Reload logos
  if(draft.reportLogos){
    reportLogos = draft.reportLogos;
    ['left','center','right'].forEach(function(pos){
      if(reportLogos[pos]) renderLogoSlot(pos, reportLogos[pos]);
    });
  }
  // Reload equipment
  document.getElementById('eqList').innerHTML = '';
  equipmentList = [];
  eqCounter = 0;
  (draft.equipmentList||[]).forEach(function(eq){ addEquipment(eq.isVehicle === true, eq); });
  // Reload labor
  laborList = [];
  document.getElementById('laborList').innerHTML = '';
  lbCounter = 0;
  (draft.laborList||[]).forEach(function(lb){ addLaborRow(lb); });
  
  updateGPSDisplay();
  alert('Draft loaded ‚úì');
}

function clearDraft(){
  if(!confirm('Clear saved draft?')) return;
  localStorage.removeItem('sitelog_draft');
  document.getElementById('savedStatus').textContent = 'Draft cleared';
  document.getElementById('savedDot').style.background = 'var(--mu)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveConfig(){
  const k = document.getElementById('apiKey').value.trim();
  const e = document.getElementById('emailTo').value.trim();
  if(k && !k.startsWith('‚Ä¢')) apiKey = k;
  if(e) emailTo = e;
  localStorage.setItem('sitelog_config', JSON.stringify({ apiKey, emailTo }));
  document.getElementById('apiKey').value = '';
  document.getElementById('apiKey').placeholder = '‚úì API key saved';
  document.getElementById('noKeyWarn').classList.remove('show');
  alert('Configuration saved ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getGPS(){
  const display = document.getElementById('gpsDisplay');
  const badge = document.getElementById('gpsBadge');
  if(!navigator.geolocation){
    display.textContent = 'GPS not supported by this browser';
    badge.textContent = 'üìç No GPS';
    return;
  }
  badge.textContent = 'üìç Getting GPS...';
  display.textContent = 'Acquiring ‚Äî please allow location access if prompted...';
  navigator.geolocation.getCurrentPosition(
    function(pos){
      gpsCoords = {
        lat: pos.coords.latitude.toFixed(6),
        lng: pos.coords.longitude.toFixed(6),
        acc: Math.round(pos.coords.accuracy)
      };
      updateGPSDisplay();
      badge.textContent = 'üìç GPS ‚úì (tap to refresh)';
      autosave();
    },
    function(err){
      let msg = 'GPS error ‚Äî tap üìç to retry';
      if(err.code === 1) msg = 'Location denied ‚Äî tap üìç button & allow access';
      if(err.code === 2) msg = 'Location unavailable ‚Äî check GPS signal';
      if(err.code === 3) msg = 'GPS timed out ‚Äî tap üìç to retry';
      display.textContent = msg;
      badge.textContent = 'üìç Tap to get GPS';
      badge.style.color = 'var(--or)';
      badge.style.borderColor = 'var(--or)';
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
  );
}
function refreshGPS(){
  document.getElementById('gpsBadge').style.color = '';
  document.getElementById('gpsBadge').style.borderColor = '';
  document.getElementById('gpsBadge').textContent = 'üìç Updating...';
  getGPS();
}
function updateGPSDisplay(){
  if(!gpsCoords) return;
  document.getElementById('gpsDisplay').textContent =
    gpsCoords.lat + ', ' + gpsCoords.lng + '  (¬±' + gpsCoords.acc + 'm)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEATHER / WIND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setWeather(btn, val){
  document.querySelectorAll('.wc').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  weatherVal = val;
  autosave();
}

async function fetchWind(){
  if(!gpsCoords){
    // Try getting GPS first, then retry
    alert('Tap the üìç GPS button first to get your location, then try again.');
    return;
  }
  const windAutoEl = document.getElementById('windAuto');
  windAutoEl.textContent = 'Fetching weather data...';
  try {
    const url = 'https://api.open-meteo.com/v1/forecast?latitude=' + gpsCoords.lat +
      '&longitude=' + gpsCoords.lng +
      '&current=temperature_2m,wind_speed_10m,wind_direction_10m' +
      '&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto';
    const res = await fetch(url);
    const data = await res.json();
    const cur = data.current || {};
    const ws = cur.wind_speed_10m !== undefined ? Math.round(cur.wind_speed_10m) : null;
    const wd = cur.wind_direction_10m !== undefined ? Math.round(cur.wind_direction_10m) : null;
    const temp = cur.temperature_2m !== undefined ? Math.round(cur.temperature_2m) : null;
    if(ws !== null) document.getElementById('windSpeed').value = ws;
    if(temp !== null) document.getElementById('temp').value = temp;
    windAutoEl.textContent = '‚úì Live data: Wind ' + (ws||'--') + ' mph @ ' + (wd||'--') + '¬∞ ¬∑ Temp ' + (temp||'--') + '¬∞F';
    autosave();
  } catch(e){
    windAutoEl.textContent = '‚ö† Could not fetch weather ‚Äî enter manually';
    console.error('Weather fetch error:', e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EQUIPMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let eqCounter = 0;
function addEquipment(isVehicle, prefillData){
  // isVehicle: boolean (true/false/undefined). prefillData: object or undefined.
  if(typeof isVehicle !== 'boolean') isVehicle = false;
  const prefill = (prefillData && typeof prefillData === 'object') ? prefillData : null;
  const id = ++eqCounter;
  const eq = prefill || { id, eqId:'', name:'', isVehicle, make:'', model:'', plate:'', vin:'', status:'Active', idleHrs:0, idleMins:0 };
  if(!prefill) equipmentList.push(eq);
  
  const div = document.createElement('div');
  div.id = 'eq-row-'+id;
  div.style.cssText = 'background:var(--dk3);border-radius:8px;padding:12px;margin-bottom:10px;';
  div.innerHTML = `
    <div style="display:grid;grid-template-columns:120px 1fr ${isVehicle?'1fr 1fr':''}  100px auto;gap:8px;align-items:end;">
      <div>
        <div class="field-label">Equip ID</div>
        <div class="field-row">
          <input type="text" id="eq-eqid-${id}" value="${eq.eqId||''}" placeholder="EQ-001" oninput="updateEq(${id},'eqId',this.value)">
          <button class="mic-btn" onclick="fieldMic(this,'eq-eqid-${id}')" title="Speak ID">üéô</button>
        </div>
      </div>
      <div>
        <div class="field-label">Name / Type</div>
        <div class="field-row">
          <input type="text" id="eq-name-${id}" value="${eq.name||''}" placeholder="${isVehicle?'Dump Truck':'Tower Crane'}" oninput="updateEq(${id},'name',this.value)">
          <button class="mic-btn" onclick="fieldMic(this,'eq-name-${id}')" title="Speak name">üéô</button>
        </div>
      </div>
      ${isVehicle ? `
      <div>
        <div class="field-label">Make &amp; Model</div>
        <div class="field-row">
          <input type="text" id="eq-make-${id}" value="${eq.make||''}" placeholder="Ford F-350" oninput="updateEq(${id},'make',this.value)">
          <button class="mic-btn" onclick="fieldMic(this,'eq-make-${id}')" title="Speak make/model">üéô</button>
        </div>
      </div>
      <div>
        <div class="field-label" style="display:flex;align-items:center;gap:6px;">
          License Plate
          <button class="btn btn-ghost btn-sm" onclick="scanPlate(${id})" title="Scan plate with camera" style="padding:2px 7px;font-size:10px;margin:0;">üì∑ Scan</button>
        </div>
        <input type="text" id="eq-plate-${id}" value="${eq.plate||''}" placeholder="ABC-1234" oninput="updateEq(${id},'plate',this.value)" style="text-transform:uppercase;">
      </div>` : ''}
      <div>
        <div class="field-label">Status</div>
        <select onchange="updateEq(${id},'status',this.value);toggleIdleRow(${id},this.value)">
          <option value="Active" ${eq.status==='Active'?'selected':''}>Active</option>
          <option value="Idle" ${eq.status==='Idle'?'selected':''}>Idle</option>
          <option value="Off Site" ${eq.status==='Off Site'?'selected':''}>Off Site</option>
          <option value="Breakdown" ${eq.status==='Breakdown'?'selected':''}>Breakdown</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button class="btn btn-red" onclick="removeEq(${id})" style="white-space:nowrap;">‚úï Remove</button>
      </div>
    </div>
    ${isVehicle ? `
    <div style="margin-top:8px;display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;">
      <div style="flex:1;min-width:180px;">
        <div class="field-label" style="margin-bottom:5px;">VIN</div>
        <div class="vin-actions">
          <input type="text" id="eq-vin-${id}" value="${eq.vin||''}" placeholder="17-character VIN" maxlength="17"
            oninput="updateEq(${id},'vin',this.value.toUpperCase());this.value=this.value.toUpperCase()"
            style="font-family:monospace;letter-spacing:1px;flex:1;min-width:0;">
          <button class="mic-btn" onclick="fieldMic(this,'eq-vin-${id}')" title="Speak VIN">üéô</button>
          <button class="mic-btn" onclick="scanVinOffline(${id})" title="Scan VIN with camera ‚Äî on-device OCR, no internet needed">üì∑</button>
          <button class="mic-btn" onclick="scanVinAI(${id})" title="Scan VIN with AI (requires internet)">ü§ñ</button>
          <button class="btn btn-ghost btn-sm" onclick="lookupVIN(${id})" title="NHTSA lookup" style="padding:2px 8px;font-size:10px;white-space:nowrap;">üîç NHTSA</button>
        </div>
        <div style="font-size:9px;color:var(--mu);margin-top:3px;">üéô speak ¬∑ üì∑ scan offline ¬∑ ü§ñ scan w/AI ¬∑ üîç lookup</div>
      </div>
      <div id="eq-nhtsa-${id}" style="font-size:11px;color:var(--or);padding-bottom:6px;max-width:260px;"></div>
    </div>` : ''}
    <div id="idle-row-${id}" style="margin-top:8px;display:${eq.status==='Idle'?'flex':'none'};align-items:center;gap:10px;background:rgba(232,99,26,.07);border:1px solid rgba(232,99,26,.3);border-radius:6px;padding:8px 12px;">
      <span style="font-size:12px;color:var(--or);font-weight:600;">‚è± Idle Time:</span>
      <div style="display:flex;align-items:center;gap:4px;">
        <input type="number" min="0" max="24" style="width:55px;" value="${eq.idleHrs||0}" placeholder="0" oninput="updateEq(${id},'idleHrs',this.value)">
        <span style="font-size:12px;color:var(--mu);">hrs</span>
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <input type="number" min="0" max="59" style="width:55px;" value="${eq.idleMins||0}" placeholder="0" oninput="updateEq(${id},'idleMins',this.value)">
        <span style="font-size:12px;color:var(--mu);">mins</span>
      </div>
      <span style="font-size:11px;color:var(--mu);display:flex;align-items:center;gap:4px;">Reason:
        <input type="text" id="eq-reason-${id}" style="width:120px;display:inline-block;" placeholder="Waiting for inspection" oninput="updateEq(${id},'idleReason',this.value)" value="${eq.idleReason||''}">
        <button class="mic-btn" onclick="fieldMic(this,'eq-reason-${id}')" title="Speak reason">üéô</button>
      </span>
    </div>
    ${isVehicle ? `<div style="margin-top:6px;"><span style="font-size:10px;color:var(--y);background:rgba(245,197,24,.1);padding:2px 7px;border-radius:4px;">üöõ VEHICLE</span></div>` : ''}
  `;
  document.getElementById('eqList').appendChild(div);
  autosave();
}

function updateEq(id, field, val){
  const eq = equipmentList.find(e=>e.id===id);
  if(eq) eq[field] = val;
  autosave();
}

function toggleIdleRow(id, status){
  const row = document.getElementById('idle-row-'+id);
  if(row) row.style.display = status==='Idle' ? 'flex' : 'none';
}

function removeEq(id){
  equipmentList = equipmentList.filter(e=>e.id!==id);
  const el = document.getElementById('eq-row-'+id);
  if(el) el.remove();
  autosave();
}

// ‚îÄ‚îÄ LICENSE PLATE SCAN (AI vision reads plate from camera photo) ‚îÄ‚îÄ
function scanPlate(eqId){
  if(!apiKey){
    alert('An API key is required for plate scanning. Add your Anthropic API key in Configuration above.');
    return;
  }
  // Open camera to capture plate photo
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.style.display = 'none';
  document.body.appendChild(input);

  input.onchange = async function(){
    const file = input.files[0];
    document.body.removeChild(input);
    if(!file) return;

    const statusEl = document.getElementById('eq-nhtsa-'+eqId);
    const plateEl  = document.getElementById('eq-plate-'+eqId);
    statusEl.textContent = 'üì∑ Reading plate‚Ä¶';

    // Compress image to stay under Claude's 5MB limit
    // License plate recognition only needs ~1200px wide ‚Äî no need for full camera res
    const base64 = await new Promise(function(resolve, reject){
      const img = new Image();
      const objectUrl = URL.createObjectURL(file);
      img.onload = function(){
        URL.revokeObjectURL(objectUrl);
        const MAX_W = 1200;
        const scale = img.width > MAX_W ? MAX_W / img.width : 1;
        const canvas = document.createElement('canvas');
        canvas.width  = Math.round(img.width  * scale);
        canvas.height = Math.round(img.height * scale);
        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
        // Quality 0.85 gives sharp text with small file size
        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
        resolve(dataUrl.split(',')[1]);
      };
      img.onerror = reject;
      img.src = objectUrl;
    });

    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method:'POST',
        headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body: JSON.stringify({
          model:'claude-sonnet-4-20250514', max_tokens:60,
          messages:[{role:'user', content:[
            {type:'image', source:{type:'base64', media_type:'image/jpeg', data:base64}},
            {type:'text', text:'Read the license plate number in this photo. Output ONLY the plate number exactly as it appears, with no spaces, dashes, or explanation. If you cannot read a plate clearly, output UNREADABLE.'}
          ]}]
        })
      });
      const data = await res.json();
      if(data.error) throw new Error(data.error.message);
      const plate = data.content.map(b=>b.text||'').join('').trim().toUpperCase().replace(/\s+/g,'');

      if(plate === 'UNREADABLE' || !plate){
        statusEl.textContent = '‚ö† Plate unreadable ‚Äî enter manually';
        return;
      }

      // Fill plate field
      plateEl.value = plate;
      updateEq(eqId, 'plate', plate);
      statusEl.textContent = '‚úì Plate scanned: ' + plate + ' ‚Äî enter VIN below for full vehicle lookup';
      autosave();

    } catch(err){
      statusEl.textContent = '‚ö† Scan error: ' + err.message;
    }
  };

  input.click();
}

// ‚îÄ‚îÄ NHTSA VIN DECODE (free federal API ‚Äî no key required) ‚îÄ‚îÄ
async function lookupVIN(eqId){
  const vinEl    = document.getElementById('eq-vin-'+eqId);
  const makeEl   = document.getElementById('eq-make-'+eqId);
  const statusEl = document.getElementById('eq-nhtsa-'+eqId);
  const vin = (vinEl ? vinEl.value : '').trim().toUpperCase();

  if(vin.length !== 17){
    statusEl.textContent = '‚ö† VIN must be exactly 17 characters';
    return;
  }

  statusEl.textContent = 'üîç Looking up VIN‚Ä¶';

  try {
    const res = await fetch('https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/' + vin + '?format=json');
    const data = await res.json();
    const results = data.Results || [];

    const get = (var_) => {
      const r = results.find(x=>x.Variable===var_);
      return (r && r.Value && r.Value !== 'Not Applicable' && r.Value !== null) ? r.Value : '';
    };

    const year   = get('Model Year');
    const make   = get('Make');
    const model  = get('Model');
    const body   = get('Body Class');
    const plant  = get('Plant Country');
    const drive  = get('Drive Type');
    const fuel   = get('Fuel Type - Primary');
    const gvwr   = get('Gross Vehicle Weight Rating From');  // lower bound of GVWR range
    const gvwrTo = get('Gross Vehicle Weight Rating To');    // upper bound (often same)
    const axles  = get('Number of Axles');
    const axleConfig = get('Axle Configuration');

    if(!make){
      statusEl.textContent = '‚ö† VIN not found in NHTSA database ‚Äî check for typos';
      return;
    }

    // Auto-fill make/model field
    const makeModel = [year, make, model].filter(Boolean).join(' ');
    if(makeEl){ makeEl.value = makeModel; updateEq(eqId, 'make', makeModel); }
    updateEq(eqId, 'vin', vin);

    // Auto-fill name/type field from NHTSA if the user left it blank
    // (the report filter uses e.name ‚Äî if empty the vehicle is skipped)
    const eqObj = equipmentList.find(e=>e.id===eqId);
    if(eqObj && !eqObj.name){
      const autoName = [year, make, model].filter(Boolean).join(' ');
      eqObj.name = autoName;
      // Also update the Name/Type input visually
      const nameInput = document.querySelector('#eq-row-'+eqId+' input[placeholder="Dump Truck"], #eq-row-'+eqId+' input[placeholder="Tower Crane"]');
      if(nameInput) nameInput.value = autoName;
    }

    // Build human-readable GVWR string
    // NHTSA returns ranges like "Class 3: 10,001 - 14,000 lb (4,536 - 6,350 kg)"
    let gvwrStr = '';
    if(gvwr && gvwrTo && gvwr !== gvwrTo) gvwrStr = gvwr + ' ‚Äì ' + gvwrTo;
    else if(gvwr) gvwrStr = gvwr;
    else if(gvwrTo) gvwrStr = gvwrTo;

    // Store full NHTSA data on the equipment record for the report
    const eq = equipmentList.find(e=>e.id===eqId);
    if(eq) eq.nhtsaInfo = { year, make, model, body, drive, fuel, plant, gvwr: gvwrStr, axles, axleConfig };

    // Show summary
    let summary = '‚úì ' + makeModel;
    if(body)    summary += ' ¬∑ ' + body;
    if(drive)   summary += ' ¬∑ ' + drive;
    if(fuel)    summary += ' ¬∑ ' + fuel;
    if(gvwrStr) summary += ' ¬∑ GVWR: ' + gvwrStr;
    if(axles)   summary += ' ¬∑ ' + axles + ' axles';
    statusEl.style.color = 'var(--green, #2ecc71)';
    statusEl.textContent = summary;
    autosave();

  } catch(err){
    statusEl.textContent = '‚ö† NHTSA lookup failed ‚Äî check internet connection';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LABOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lbCounter = 0;
function addLabor(){ addLaborRow(null); }
function addLaborRow(prefillData){
  const prefill = (prefillData && typeof prefillData === 'object') ? prefillData : null;
  const id = ++lbCounter;
  const lb = prefill || { id, name:'', role:'', company:'' };
  if(!prefill) laborList.push(lb);
  
  const div = document.createElement('div');
  div.id = 'lb-row-'+id;
  div.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 1fr 36px;gap:8px;align-items:end;padding:8px 0;border-bottom:1px solid var(--dk3);';
  div.innerHTML = `
    <div>
      ${id===1?'<div class="field-label">Legal Full Name</div>':''}
      <div class="field-row">
        <input type="text" id="lb-name-${id}" value="${lb.name||''}" placeholder="First Last" oninput="updateLb(${id},'name',this.value)">
        <button class="mic-btn" onclick="fieldMic(this,'lb-name-${id}')" title="Speak name">üéô</button>
      </div>
    </div>
    <div>
      ${id===1?'<div class="field-label">Role / Trade</div>':''}
      <div class="field-row">
        <input type="text" id="lb-role-${id}" value="${lb.role||''}" placeholder="Carpenter, Electrician..." oninput="updateLb(${id},'role',this.value)">
        <button class="mic-btn" onclick="fieldMic(this,'lb-role-${id}')" title="Speak role">üéô</button>
      </div>
    </div>
    <div>
      ${id===1?'<div class="field-label">Company / Sub</div>':''}
      <div class="field-row">
        <input type="text" id="lb-co-${id}" value="${lb.company||''}" placeholder="ABC Contractors" oninput="updateLb(${id},'company',this.value)">
        <button class="mic-btn" onclick="fieldMic(this,'lb-co-${id}')" title="Speak company">üéô</button>
      </div>
    </div>
    <div style="${id===1?'padding-top:18px':''}">
      <button class="btn btn-red" onclick="removeLb(${id})" style="padding:8px 10px;font-size:14px;line-height:1;">‚úï</button>
    </div>
  `;
  document.getElementById('laborList').appendChild(div);
  autosave();
}

function updateLb(id, field, val){
  const lb = laborList.find(l=>l.id===id);
  if(lb) lb[field] = val;
  autosave();
}

function removeLb(id){
  laborList = laborList.filter(l=>l.id!==id);
  const el = document.getElementById('lb-row-'+id);
  if(el) el.remove();
  autosave();
}

function addLaborBulk(){ document.getElementById('bulkModal').classList.add('show'); }
function processBulkLabor(){
  const lines = document.getElementById('bulkText').value.trim().split('\n');
  lines.forEach(function(line){
    const parts = line.split(',');
    if(!parts[0].trim()) return;
    const lb = { id: ++lbCounter, name: parts[0].trim(), role: (parts[1]||'').trim(), company: (parts[2]||'').trim() };
    laborList.push(lb);
    addLaborRow(lb);
  });
  document.getElementById('bulkText').value = '';
  document.getElementById('bulkModal').classList.remove('show');
  autosave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LANGUAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setLang(btn, lang){
  document.querySelectorAll('.lp').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  inputLang = lang;
  const ta = document.getElementById('voiceText');
  const placeholders = {
    en:'e.g. Poured 40m¬≥ concrete on columns C1-C8, done at noon...',
    es:'p.ej. Vaciamos 40m¬≥ de concreto en columnas C1-C8, terminamos al mediod√≠a...',
    zh:'‰æãÂ¶ÇÔºöÂú®Êü±Â≠êC1-C8ÊµáÁ≠ë‰∫Ü40Á´ãÊñπÁ±≥Ê∑∑ÂáùÂúüÔºå‰∏≠ÂçàÂÆåÂ∑•...',
    vi:'vd. ƒê·ªï 40m¬≥ b√™ t√¥ng tr√™n c·ªôt C1-C8, ho√†n th√†nh v√†o tr∆∞a...'
  };
  ta.placeholder = placeholders[lang] || placeholders.en;
  autosave();
}

function setLangByCode(lang){
  const btn = document.querySelector(`.lp[data-lang="${lang}"]`);
  if(btn) setLang(btn, lang);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE RECORDING ‚Äî Web Speech API (real-time, on-device)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Uses the browser's built-in SpeechRecognition ‚Äî works in
// Chrome (desktop + Android) and Safari 14.1+ (iOS/macOS).
// No API key needed. Transcription happens live as you speak.

let speechRecognition = null;
let speechFinalText   = '';   // committed final segments
let speechInterim     = '';   // current in-progress segment

const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;

function toggleRecord(){
  const btn = document.getElementById('recordBtn');
  const ta  = document.getElementById('voiceText');

  // Stop any active field mic to avoid audio conflicts
  if(typeof stopFieldMic === 'function') stopFieldMic();

  // ‚îÄ‚îÄ STOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(isRecording){
    isRecording = false;
    if(speechRecognition) speechRecognition.stop();
    btn.classList.remove('recording');
    btn.innerHTML = '<div class="mic-dot"></div> Record Voice';
    // Flush any remaining interim text into the textarea
    if(speechInterim.trim()){
      ta.value = (ta.value ? ta.value.trimEnd() + ' ' : '') + speechInterim.trim();
      speechInterim = '';
    }
    autosave();
    showStatus('‚úì Voice recording saved', false);
    setTimeout(hideStatus, 2000);
    return;
  }

  // ‚îÄ‚îÄ Browser support check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!SpeechRecognitionAPI){
    // Fallback: MediaRecorder with clear instructions
    alert('Live voice transcription is not supported in this browser.\n\nFor voice-to-text, please use:\n‚Ä¢ Chrome on Android or Desktop\n‚Ä¢ Safari on iPhone/iPad (iOS 14.1+)\n\nOr type your notes directly into the text box.');
    return;
  }

  // ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const langCodes = { en:'en-US', es:'es-MX', zh:'zh-CN', vi:'vi-VN' };

  speechFinalText = '';
  speechInterim   = '';

  speechRecognition = new SpeechRecognitionAPI();
  speechRecognition.continuous      = true;   // keep listening until stopped
  speechRecognition.interimResults  = true;   // show words as they're spoken
  speechRecognition.lang            = langCodes[inputLang] || 'en-US';
  speechRecognition.maxAlternatives = 1;

  speechRecognition.onstart = function(){
    isRecording = true;
    btn.classList.add('recording');
    btn.innerHTML = '<div class="mic-dot"></div> Recording‚Ä¶ (tap to stop)';
    showStatus('üéô Listening ‚Äî speak your site notes‚Ä¶', false);
  };

  speechRecognition.onresult = function(event){
    let interimBuild = '';
    for(let i = event.resultIndex; i < event.results.length; i++){
      const segment = event.results[i][0].transcript;
      if(event.results[i].isFinal){
        // Capitalise first letter, ensure ends with punctuation
        let clean = segment.trim();
        if(clean && !/[.!?]$/.test(clean)) clean += '.';
        clean = clean.charAt(0).toUpperCase() + clean.slice(1);
        speechFinalText += (speechFinalText ? ' ' : '') + clean;
      } else {
        interimBuild += segment;
      }
    }
    speechInterim = interimBuild;

    // Live preview ‚Äî show committed text + grey interim
    const existing = ta.dataset.preVoice || '';  // text that existed before recording
    const live = speechFinalText + (speechInterim ? ' ' + speechInterim : '');
    ta.value = existing + (existing && live ? ' ' : '') + live;
  };

  speechRecognition.onerror = function(event){
    // 'no-speech' is harmless ‚Äî just waiting for voice
    if(event.error === 'no-speech') return;
    if(event.error === 'not-allowed' || event.error === 'service-not-allowed'){
      showStatus('‚ö† Microphone permission denied ‚Äî allow mic access and try again', false);
    } else {
      showStatus('‚ö† Voice recognition error: ' + event.error + ' ‚Äî type notes manually', false);
    }
    setTimeout(hideStatus, 5000);
    // Clean up
    isRecording = false;
    btn.classList.remove('recording');
    btn.innerHTML = '<div class="mic-dot"></div> Record Voice';
  };

  speechRecognition.onend = function(){
    // Auto-restart if we're still supposed to be recording (handles mobile timeouts)
    if(isRecording){
      try { speechRecognition.start(); } catch(e){ /* already started */ }
    } else {
      hideStatus();
    }
  };

  // Save whatever is currently in the textarea before we start appending to it
  ta.dataset.preVoice = ta.value;

  try {
    speechRecognition.start();
  } catch(e){
    alert('Could not start voice recognition: ' + e.message);
    isRecording = false;
  }
}

function addHint(text){
  const ta = document.getElementById('voiceText');
  ta.value += (ta.value && !ta.value.endsWith('\n') ? '\n' : '') + text;
  ta.focus();
}

function clearNotes(){
  document.getElementById('voiceText').value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SECTION TOGGLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togSection(key){
  const el = document.getElementById('tog-'+key);
  if(selectedSections.has(key)){
    selectedSections.delete(key); el.classList.remove('active'); el.querySelector('.tog-box').textContent='';
  } else {
    selectedSections.add(key); el.classList.add('active'); el.querySelector('.tog-box').textContent='‚úì';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Pending GPS fetch for the photo currently being taken
// (filled while camera is open, applied when photo comes back)
let pendingPhotoGps = null;
let pendingPhotoGpsDone = false;

function takePhotoWithGPS(){
  // Reset pending state
  pendingPhotoGps = null;
  pendingPhotoGpsDone = false;

  // ‚îÄ‚îÄ MUST open camera inside the user-gesture call stack ‚îÄ‚îÄ
  // iOS Safari blocks programmatic .click() on file inputs once
  // we go async (e.g. inside a geolocation callback). Open first.
  document.getElementById('photoCamera').click();

  // ‚îÄ‚îÄ Fetch GPS in parallel while camera is open ‚îÄ‚îÄ
  if(navigator.geolocation){
    showStatus('üìç Getting GPS‚Ä¶', true);
    navigator.geolocation.getCurrentPosition(
      function(pos){
        hideStatus();
        pendingPhotoGps = {
          lat: pos.coords.latitude.toFixed(6),
          lng: pos.coords.longitude.toFixed(6),
          acc: Math.round(pos.coords.accuracy)
        };
        pendingPhotoGpsDone = true;
        // Also update the app-wide GPS display
        gpsCoords = pendingPhotoGps;
        updateGPSDisplay();
      },
      function(){ hideStatus(); pendingPhotoGpsDone = true; /* no GPS */ },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  } else {
    pendingPhotoGpsDone = true;
  }
}

// ‚îÄ‚îÄ CAMERA PHOTO handler ‚îÄ‚îÄ
// GPS may or may not have arrived yet ‚Äî wait up to 12s for it,
// then render the card with whatever we have.
function handleCameraPhoto(files){
  const now = new Date();
  const timestamp = now.toLocaleString('en-US', {
    month:'short', day:'2-digit', year:'numeric',
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true
  });

  Array.from(files).forEach(f => {
    if(!f.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = e => {
      const id = ++photoCounter;
      const dataUrl = e.target.result;
      // Add photo to array with null GPS for now
      const photoObj = { id, dataUrl, base64: dataUrl.split(',')[1], mimeType: f.type,
                         caption: '', category: 'general', timestamp, gps: null };
      photos.push(photoObj);
      renderPhotoCard(id, dataUrl, timestamp, null);
      updatePhotoStats();

      // Poll for GPS ‚Äî the geolocation callback may still be in flight
      // Check every 300ms, give up after 12s
      let waited = 0;
      const interval = setInterval(function(){
        waited += 300;
        if(pendingPhotoGpsDone || waited >= 12000){
          clearInterval(interval);
          if(pendingPhotoGps){
            photoObj.gps = pendingPhotoGps;
            updatePhotoCardGPS(id, pendingPhotoGps);
          }
        }
      }, 300);
    };
    reader.readAsDataURL(f);
  });
  document.getElementById('photoCamera').value = '';
}

// Inject / update the GPS link on an already-rendered photo card
function updatePhotoCardGPS(id, gps){
  const card = document.getElementById('pcard-'+id);
  if(!card || !gps || !gps.lat) return;
  const lat = parseFloat(gps.lat).toFixed(6);
  const lng = parseFloat(gps.lng).toFixed(6);
  const accText = (gps.acc != null) ? ` ¬±${Math.round(gps.acc)}m` : '';
  const mapsUrl = `https://maps.apple.com/?ll=${lat},${lng}&z=18&t=h`;
  // Remove any existing GPS element first
  const existing = card.querySelector('.photo-gps-link');
  if(existing) existing.remove();
  // Insert after the timestamp line
  const tsLine = card.querySelector('.photo-ts');
  if(!tsLine) return;
  const a = document.createElement('a');
  a.className = 'photo-gps-link';
  a.href = mapsUrl;
  a.target = '_blank';
  a.rel = 'noopener';
  a.title = 'Open in Maps';
  a.style.cssText = 'display:block;font-size:10px;color:#4db8ff;font-family:"DM Mono",monospace;' +
    'text-decoration:none;margin-bottom:4px;line-height:1.5;word-break:break-all;' +
    'background:rgba(52,152,219,.12);border-radius:4px;padding:2px 5px;';
  a.textContent = `üìç ${lat}, ${lng}${accText}`;
  tsLine.insertAdjacentElement('afterend', a);
}

// ‚îÄ‚îÄ GALLERY PHOTO: extract EXIF GPS + date from each file ‚îÄ‚îÄ
async function handleGalleryPhotos(files){
  for(const f of Array.from(files)){
    if(!f.type.startsWith('image/')) continue;

    // Try to read EXIF metadata (GPS + date) using exifr
    let photoGps = null;
    let timestamp = new Date().toLocaleString('en-US', {
      month:'short', day:'2-digit', year:'numeric',
      hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true
    });

    try {
      if(typeof exifr !== 'undefined'){
        // exifr full build ‚Äî parse all GPS + date tags
        const exif = await exifr.parse(f, { gps: true, tiff: true, exif: true });
        if(exif){
          // exifr returns latitude/longitude as decimal degrees (negative = S/W)
          if(exif.latitude != null && exif.longitude != null){
            photoGps = {
              lat: exif.latitude.toFixed(6),
              lng: exif.longitude.toFixed(6),
              acc: null
            };
          }
          // Use shutter-fired timestamp if available
          const exifDate = exif.DateTimeOriginal || exif.CreateDate || exif.DateTime;
          if(exifDate instanceof Date && !isNaN(exifDate.getTime())){
            timestamp = exifDate.toLocaleString('en-US', {
              month:'short', day:'2-digit', year:'numeric',
              hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true
            });
          }
        }
      }
    } catch(e){ console.warn('EXIF read failed:', e); }

    // Read image data
    await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => {
        const id = ++photoCounter;
        const dataUrl = e.target.result;
        photos.push({ id, dataUrl, base64: dataUrl.split(',')[1], mimeType: f.type,
                      caption: '', category: 'general', timestamp, gps: photoGps });
        renderPhotoCard(id, dataUrl, timestamp, photoGps);
        updatePhotoStats();
        resolve();
      };
      reader.readAsDataURL(f);
    });
  }
  document.getElementById('photoGallery').value = '';
}

// ‚îÄ‚îÄ RENDER PHOTO CARD ‚îÄ‚îÄ
function renderPhotoCard(id, dataUrl, timestamp, gps){
  const grid = document.getElementById('photoGrid');
  const card = document.createElement('div');
  card.className = 'photo-card';
  card.id = 'pcard-'+id;

  // GPS link ‚Äî rendered immediately if coords already known, otherwise injected later by updatePhotoCardGPS
  let gpsLine = '';
  if(gps && gps.lat && gps.lng){
    const lat = parseFloat(gps.lat).toFixed(6);
    const lng = parseFloat(gps.lng).toFixed(6);
    const accText = (gps.acc != null) ? ` ¬±${Math.round(gps.acc)}m` : '';
    const mapsUrl = `https://maps.apple.com/?ll=${lat},${lng}&z=18&t=h`;
    gpsLine = `<a class="photo-gps-link" href="${mapsUrl}" target="_blank" rel="noopener"
      title="Open in Maps"
      style="display:block;font-size:10px;color:#4db8ff;font-family:'DM Mono',monospace;
             text-decoration:none;margin-bottom:4px;line-height:1.5;word-break:break-all;
             background:rgba(52,152,219,.12);border-radius:4px;padding:2px 5px;">
      üìç ${lat}, ${lng}${accText}</a>`;
  }

  card.innerHTML = `
    <img src="${dataUrl}" alt="Photo ${id}">
    <div class="ai-done-badge" id="aibadge-${id}">AI ‚úì</div>
    <button class="photo-remove" onclick="removePhoto(${id})">√ó</button>
    <div class="photo-card-body">
      <div class="photo-ts" style="font-size:10px;color:var(--mu);margin-bottom:3px;">üïê ${timestamp||''}</div>
      ${gpsLine}
      <textarea class="photo-caption-input" id="pcap-${id}" placeholder="Tap üéô to speak caption, or type..." style="font-size:11px;min-height:40px;background:transparent;border:none;width:100%;color:var(--lt);font-family:'DM Sans',sans-serif;resize:none;outline:none;" oninput="updatePhotoCap(${id},this.value)"></textarea>
    </div>
    <div class="photo-card-foot">
      <select class="photo-cat" onchange="updatePhotoCat(${id},this.value)">
        <option value="general">General</option>
        <option value="progress">Progress</option>
        <option value="safety">Safety</option>
        <option value="quality">Quality</option>
        <option value="defect">Defect</option>
        <option value="material">Material</option>
        <option value="equipment">Equipment</option>
      </select>
      <button class="photo-ai-btn mic-btn" id="paibtn-${id}" onclick="photoFieldMic(this,${id})" title="Speak caption">üéô Speak</button>
    </div>
  `;
  grid.appendChild(card);
}

function updatePhotoCap(id,v){ const p=photos.find(x=>x.id===id); if(p) p.caption=v; }
function updatePhotoCat(id,v){ const p=photos.find(x=>x.id===id); if(p) p.category=v; }
function removePhoto(id){ photos=photos.filter(x=>x.id!==id); const el=document.getElementById('pcard-'+id); if(el) el.remove(); updatePhotoStats(); }
function updatePhotoStats(){
  document.getElementById('photoStats').textContent = photos.length ? photos.length+' photo'+(photos.length>1?'s':'')+' attached' : 'No photos';
  document.getElementById('aiAllBtn').style.display = photos.length ? 'inline-block' : 'none';
}

async function captionPhoto(id){
  if(!apiKey){ document.getElementById('noKeyWarn').classList.add('show'); return; }
  const photo = photos.find(p=>p.id===id);
  if(!photo) return;
  const btn = document.getElementById('paibtn-'+id);
  btn.textContent = '...'; btn.style.opacity='.5';
  try {
    const res = await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body:JSON.stringify({
        model:"claude-sonnet-4-20250514",max_tokens:120,
        messages:[{role:"user",content:[
          {type:"image",source:{type:"base64",media_type:photo.mimeType,data:photo.base64}},
          {type:"text",text:"Write a 1-2 sentence professional construction site photo caption (max 25 words). Describe what is visible: activity, location, materials, conditions. Use technical terms. Output ONLY the caption."}
        ]}]
      })
    });
    const data = await res.json();
    if(data.error) throw new Error(data.error.message);
    const cap = data.content.map(b=>b.text||'').join('').trim();
    photo.caption = cap;
    document.getElementById('pcap-'+id).value = cap;
    document.getElementById('aibadge-'+id).classList.add('show');
  } catch(e){ console.error(e); }
  btn.textContent = '‚ö° AI Caption'; btn.style.opacity='1';
}

async function captionAll(){ for(const p of photos) await captionPhoto(p.id); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PER-FIELD VOICE MIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// One shared SpeechRecognition instance for all field mics.
// Only one field can be recording at a time ‚Äî tapping a new
// mic auto-stops the previous one.

let fieldMicRecognition  = null;
let fieldMicActiveBtn    = null;  // the currently lit-up mic button
let fieldMicTargetId     = null;  // input/textarea element id being filled
let fieldMicFinal        = '';    // committed text for current session

function fieldMic(btn, inputId){
  const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechAPI){
    alert('Voice input requires Chrome or Safari on iPhone (iOS 14.1+). Firefox does not support the Web Speech API.');
    return;
  }

  // If this same button is already recording ‚Üí stop it
  if(fieldMicActiveBtn === btn){
    stopFieldMic();
    return;
  }

  // Stop any currently active field mic
  stopFieldMic();

  // Start new recognition on the target field
  fieldMicTargetId = inputId;
  fieldMicActiveBtn = btn;
  const el = document.getElementById(inputId);
  fieldMicFinal = el ? (el.value || el.textContent || '') : '';
  // Save what was there before so we can append cleanly
  const preExisting = fieldMicFinal;

  btn.classList.add('active');
  btn.title = 'Tap to stop';

  const rec = new SpeechAPI();
  rec.lang = ({en:'en-US',es:'es-MX',zh:'zh-CN',vi:'vi-VN'})[inputLang] || 'en-US';
  rec.continuous      = true;
  rec.interimResults  = true;
  fieldMicRecognition = rec;

  rec.onresult = function(event){
    let finalSeg = '';
    let interimSeg = '';
    for(let i = event.resultIndex; i < event.results.length; i++){
      const t = event.results[i][0].transcript;
      if(event.results[i].isFinal) finalSeg += t;
      else interimSeg += t;
    }
    if(finalSeg){
      // Auto-capitalise first char, add space between segments
      const seg = finalSeg.trim();
      const cap = seg.charAt(0).toUpperCase() + seg.slice(1);
      fieldMicFinal += (fieldMicFinal && !fieldMicFinal.endsWith(' ') ? ' ' : '') + cap;
    }
    const el = document.getElementById(fieldMicTargetId);
    if(el){
      el.value = fieldMicFinal + (interimSeg ? ' ' + interimSeg : '');
      // Fire oninput so updateLb / updateEq pick up the value
      el.dispatchEvent(new Event('input', {bubbles:true}));
    }
  };

  rec.onerror = function(e){
    if(e.error === 'no-speech') return;
    stopFieldMic();
  };

  rec.onend = function(){
    // Auto-restart if still recording (handles iOS 60s timeout)
    if(fieldMicActiveBtn === btn){
      try { rec.start(); } catch(e){ stopFieldMic(); }
    }
  };

  try { rec.start(); }
  catch(e){ btn.classList.remove('active'); fieldMicActiveBtn = null; }
}

function stopFieldMic(){
  if(fieldMicRecognition){
    try { fieldMicRecognition.stop(); } catch(e){}
    fieldMicRecognition = null;
  }
  if(fieldMicActiveBtn){
    fieldMicActiveBtn.classList.remove('active');
    fieldMicActiveBtn.title = fieldMicActiveBtn.title.replace('Tap to stop','Speak');
    fieldMicActiveBtn = null;
  }
  fieldMicTargetId = null;
  fieldMicFinal = '';
}

// Photo caption voice ‚Äî same engine, targets the photo textarea
function photoFieldMic(btn, photoId){
  const textareaId = 'pcap-' + photoId;
  fieldMic(btn, textareaId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREW TEMPLATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CREW_TPL_KEY = 'sitelog_crew_templates';

function getCrewTemplates(){
  try { return JSON.parse(localStorage.getItem(CREW_TPL_KEY) || '[]'); }
  catch(e){ return []; }
}

function saveCrewTemplate(){
  const crew = laborList.filter(l => l.name || l.role);
  if(crew.length === 0){ alert('Add at least one worker before saving a template.'); return; }
  const name = prompt('Name this crew template:\n(e.g. "ABC Bridge Night Crew")', 'Crew ' + new Date().toLocaleDateString());
  if(!name) return;
  const templates = getCrewTemplates();
  // Replace existing template with same name
  const idx = templates.findIndex(t => t.name === name);
  const entry = { name, saved: new Date().toLocaleString(), count: crew.length, crew };
  if(idx >= 0) templates[idx] = entry; else templates.push(entry);
  localStorage.setItem(CREW_TPL_KEY, JSON.stringify(templates));
  alert('‚úì Crew template "' + name + '" saved (' + crew.length + ' workers)');
}

function openCrewTemplates(){
  const templates = getCrewTemplates();
  const list = document.getElementById('crewTplList');
  list.innerHTML = '';
  if(templates.length === 0){
    list.innerHTML = '<div class="tpl-empty">No crew templates saved yet.<br>Add workers and tap üíæ Save Template.</div>';
  } else {
    templates.forEach(function(t, i){
      const item = document.createElement('div');
      item.className = 'tpl-item';
      item.innerHTML = `
        <div style="flex:1;">
          <div class="tpl-item-name">${t.name}</div>
          <div class="tpl-item-meta">${t.count} workers ¬∑ saved ${t.saved}</div>
        </div>
        <button class="btn btn-y btn-sm" onclick="loadCrewTemplate(${i})">Load</button>
        <button class="btn btn-red" onclick="deleteCrewTemplate(${i})" style="padding:5px 9px;">‚úï</button>
      `;
      list.appendChild(item);
    });
  }
  document.getElementById('crewTplModal').classList.add('show');
}

function loadCrewTemplate(idx){
  const templates = getCrewTemplates();
  const t = templates[idx];
  if(!t) return;
  const mode = confirm('Load "' + t.name + '"?\n\nOK = Replace current crew\nCancel = Append to current crew');
  if(mode === null) return; // dismissed ‚Äî do nothing
  if(mode){
    // Replace
    laborList = [];
    document.getElementById('laborList').innerHTML = '';
    lbCounter = 0;
  }
  t.crew.forEach(function(lb){
    const entry = { id: ++lbCounter, name: lb.name||'', role: lb.role||'', company: lb.company||'' };
    laborList.push(entry);
    addLaborRow(entry);
  });
  autosave();
  document.getElementById('crewTplModal').classList.remove('show');
}

function deleteCrewTemplate(idx){
  const templates = getCrewTemplates();
  if(!confirm('Delete template "' + templates[idx].name + '"?')) return;
  templates.splice(idx, 1);
  localStorage.setItem(CREW_TPL_KEY, JSON.stringify(templates));
  openCrewTemplates(); // refresh modal
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EQUIPMENT TEMPLATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EQ_TPL_KEY = 'sitelog_eq_templates';

function getEqTemplates(){
  try { return JSON.parse(localStorage.getItem(EQ_TPL_KEY) || '[]'); }
  catch(e){ return []; }
}

function saveEqTemplate(){
  const equip = equipmentList.filter(e => e.name || e.make || e.plate);
  if(equip.length === 0){ alert('Add at least one piece of equipment before saving a template.'); return; }
  const name = prompt('Name this equipment template:\n(e.g. "ABC Bridge Equipment")', 'Equipment ' + new Date().toLocaleDateString());
  if(!name) return;
  const templates = getEqTemplates();
  const idx = templates.findIndex(t => t.name === name);
  const entry = { name, saved: new Date().toLocaleString(), count: equip.length, equipment: equip };
  if(idx >= 0) templates[idx] = entry; else templates.push(entry);
  localStorage.setItem(EQ_TPL_KEY, JSON.stringify(templates));
  alert('‚úì Equipment template "' + name + '" saved (' + equip.length + ' items)');
}

function openEqTemplates(){
  const templates = getEqTemplates();
  const list = document.getElementById('eqTplList');
  list.innerHTML = '';
  if(templates.length === 0){
    list.innerHTML = '<div class="tpl-empty">No equipment templates saved yet.<br>Add equipment and tap üíæ Save Template.</div>';
  } else {
    templates.forEach(function(t, i){
      const item = document.createElement('div');
      item.className = 'tpl-item';
      item.innerHTML = `
        <div style="flex:1;">
          <div class="tpl-item-name">${t.name}</div>
          <div class="tpl-item-meta">${t.count} items ¬∑ saved ${t.saved}</div>
        </div>
        <button class="btn btn-y btn-sm" onclick="loadEqTemplate(${i})">Load</button>
        <button class="btn btn-red" onclick="deleteEqTemplate(${i})" style="padding:5px 9px;">‚úï</button>
      `;
      list.appendChild(item);
    });
  }
  document.getElementById('eqTplModal').classList.add('show');
}

function loadEqTemplate(idx){
  const templates = getEqTemplates();
  const t = templates[idx];
  if(!t) return;
  const mode = confirm('Load "' + t.name + '"?\n\nOK = Replace current equipment list\nCancel = Append to current list');
  if(mode === null) return;
  if(mode){
    equipmentList = [];
    document.getElementById('eqList').innerHTML = '';
    eqCounter = 0;
  }
  t.equipment.forEach(function(eq){
    // Reset id and status ‚Äî keep all NHTSA/vehicle info
    const entry = Object.assign({}, eq, { id: ++eqCounter, status: 'Active', idleHrs: 0, idleMins: 0, idleReason: '' });
    equipmentList.push(entry);
    addEquipment(entry.isVehicle === true, entry);
  });
  autosave();
  document.getElementById('eqTplModal').classList.remove('show');
}

function deleteEqTemplate(idx){
  const templates = getEqTemplates();
  if(!confirm('Delete template "' + templates[idx].name + '"?')) return;
  templates.splice(idx, 1);
  localStorage.setItem(EQ_TPL_KEY, JSON.stringify(templates));
  openEqTemplates(); // refresh modal
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT LOGOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _logoPickingPos = null; // which slot is being filled: 'left'|'center'|'right'

function pickLogo(pos){
  _logoPickingPos = pos;
  const inp = document.getElementById('logoFileInput');
  inp.value = '';
  inp.click();
}

function handleLogoUpload(files){
  const f = files[0];
  if(!f || !_logoPickingPos) return;
  const pos = _logoPickingPos;
  const reader = new FileReader();
  reader.onload = function(e){
    reportLogos[pos] = e.target.result;   // base64 data URL
    renderLogoSlot(pos, e.target.result);
    autosave();
  };
  reader.readAsDataURL(f);
}

function renderLogoSlot(pos, dataUrl){
  const slot = document.getElementById('logoSlot-' + pos);
  if(!slot) return;
  // Clear placeholder text, show image
  slot.innerHTML = `
    <img src="${dataUrl}" alt="${pos} logo">
    <button class="logo-slot-remove" id="logoRemove-${pos}"
      onclick="event.stopPropagation();removeLogo('${pos}')">√ó</button>
  `;
}

function removeLogo(pos){
  reportLogos[pos] = null;
  const slot = document.getElementById('logoSlot-' + pos);
  const labels = { left:'Owner Logo', center:'Project Logo', right:'Contractor Logo' };
  if(slot){
    slot.innerHTML = `
      <div class="logo-slot-label">Ôºã<br>${labels[pos]}</div>
      <button class="logo-slot-remove" id="logoRemove-${pos}"
        onclick="event.stopPropagation();removeLogo('${pos}')">√ó</button>
    `;
  }
  autosave();
}

// Called from renderReport ‚Äî injects logos into the on-screen report panel
function renderReportLogoBar(){
  const bar = document.getElementById('reportLogoBar');
  if(!bar) return;
  const hasAny = reportLogos.left || reportLogos.center || reportLogos.right;
  if(!hasAny){ bar.style.display = 'none'; bar.innerHTML = ''; return; }
  bar.style.display = 'grid';
  bar.style.gridTemplateColumns = '1fr 1fr 1fr';
  bar.style.gap = '12px';
  bar.style.alignItems = 'center';
  const mk = (pos, align) => reportLogos[pos]
    ? `<div style="text-align:${align};"><img src="${reportLogos[pos]}"
         style="max-height:56px;max-width:140px;object-fit:contain;"></div>`
    : `<div></div>`;
  bar.innerHTML = mk('left','left') + mk('center','center') + mk('right','right');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIN SCANNING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ OFFLINE: native iOS "Scan Text" via Live Text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// iOS 15+ lets the user long-press any focused text field and
// choose "Scan Text" from the context menu ‚Äî fully on-device ML,
// zero internet needed. We trigger it by focusing the VIN field
// and showing a short instruction toast. No API call required.
// ‚îÄ‚îÄ OFFLINE: camera photo ‚Üí Tesseract.js on-device OCR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Opens rear camera, then runs OCR locally in the browser.
// No internet required after Tesseract.js script loads (it caches its
// language model in IndexedDB on first use, so subsequent scans are instant).
let tesseractWorker = null; // lazy-init, reused across scans

async function scanVinOffline(eqId){
  const vinEl    = document.getElementById('eq-vin-'   + eqId);
  const statusEl = document.getElementById('eq-nhtsa-' + eqId);
  if(!vinEl) return;

  // Open rear camera ‚Äî same iOS-safe pattern as plate scan
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.style.display = 'none';
  document.body.appendChild(input);

  input.onchange = async function(){
    const file = input.files[0];
    document.body.removeChild(input);
    if(!file) return;

    statusEl.style.color = 'var(--bl)';
    statusEl.textContent = 'üîç Reading VIN on device‚Ä¶';

    try {
      // ‚îÄ‚îÄ Preprocess: sharpen contrast before OCR ‚îÄ‚îÄ
      // Load image into canvas, boost contrast, convert to greyscale
      const imgUrl = URL.createObjectURL(file);
      const processed = await preprocessForOCR(imgUrl);
      URL.revokeObjectURL(imgUrl);

      // ‚îÄ‚îÄ Init Tesseract worker (reused) ‚îÄ‚îÄ
      if(!tesseractWorker){
        statusEl.textContent = '‚è≥ Loading OCR engine (one-time, ~2MB)‚Ä¶';
        tesseractWorker = await Tesseract.createWorker('eng', 1, {
          // Restrict to VIN character set: A-H J-N P R-Z 0-9
          // (VINs never contain I, O, Q)
          tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789',
          logger: function(){}   // suppress verbose logging
        });
        await tesseractWorker.setParameters({
          tessedit_pageseg_mode: '7',  // treat image as single text line
          tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789'
        });
      }

      statusEl.textContent = 'üîç Scanning VIN characters‚Ä¶';
      const { data } = await tesseractWorker.recognize(processed);

      // Extract only valid VIN characters and find 17-char sequence
      const raw = (data.text || '').toUpperCase().replace(/[^ABCDEFGHJKLMNPRSTUVWXYZ0123456789]/g, '');
      // Try to find a 17-char substring ‚Äî VINs are always exactly 17 chars
      let vin = '';
      if(raw.length >= 17){
        // Prefer a substring that starts with a letter (VINs always start with a WMI code)
        const match = raw.match(/[A-HJ-NPR-Z][A-HJ-NPR-Z0-9]{16}/);
        vin = match ? match[0] : raw.substring(0, 17);
      }

      if(!vin || vin.length !== 17){
        statusEl.style.color = 'var(--or)';
        statusEl.textContent = raw.length > 0
          ? `‚ö† Got "${raw}" ‚Äî hold camera steady, fill frame with VIN sticker, tap üì∑ again`
          : '‚ö† No text found ‚Äî ensure VIN is in focus and well-lit, tap üì∑ again';
        return;
      }

      vinEl.value = vin;
      updateEq(eqId, 'vin', vin);
      statusEl.style.color = 'var(--gr)';
      statusEl.textContent = '‚úì VIN read: ' + vin + ' ‚Äî tap üîç NHTSA to verify';
      autosave();

    } catch(err){
      statusEl.style.color = 'var(--rd)';
      statusEl.textContent = '‚ö† OCR error: ' + err.message;
      console.error('Tesseract error:', err);
    }
  };

  input.click();
}

// Preprocess image: greyscale + contrast boost ‚Üí helps Tesseract read VIN plates
function preprocessForOCR(imgUrl){
  return new Promise(function(resolve, reject){
    const img = new Image();
    img.onload = function(){
      const MAX = 1800;
      const scale = img.width > MAX ? MAX / img.width : 1;
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      // Convert to greyscale + boost contrast
      const id = ctx.getImageData(0, 0, w, h);
      const d  = id.data;
      for(let i = 0; i < d.length; i += 4){
        // Luminance
        const g = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
        // Contrast stretch: push darks darker, lights lighter
        const c = Math.min(255, Math.max(0, (g - 128) * 1.6 + 128));
        d[i] = d[i+1] = d[i+2] = c;
      }
      ctx.putImageData(id, 0, 0);
      resolve(canvas.toDataURL('image/png'));
    };
    img.onerror = reject;
    img.src = imgUrl;
  });
}

// ‚îÄ‚îÄ ONLINE: AI vision reads VIN from a camera photo ‚îÄ‚îÄ‚îÄ‚îÄ
// Same compression + Claude API approach used for plate scanning.
// Falls back gracefully if no API key or no internet.
function scanVinAI(eqId){
  if(!apiKey){
    alert('AI VIN scan requires an Anthropic API key. Use the üì∑ offline scan instead, or enter the VIN manually.');
    return;
  }
  if(!navigator.onLine){
    alert('No internet connection. Use the üì∑ offline scan instead ‚Äî tap üì∑ then long-press the field and choose "Scan Text".');
    return;
  }

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.style.display = 'none';
  document.body.appendChild(input);

  input.onchange = async function(){
    const file = input.files[0];
    document.body.removeChild(input);
    if(!file) return;

    const statusEl = document.getElementById('eq-nhtsa-' + eqId);
    const vinEl    = document.getElementById('eq-vin-'   + eqId);
    statusEl.style.color = 'var(--or)';
    statusEl.textContent = 'ü§ñ Reading VIN‚Ä¶';

    // Compress for Claude 5MB limit
    const base64 = await new Promise(function(resolve, reject){
      const img = new Image();
      const objectUrl = URL.createObjectURL(file);
      img.onload = function(){
        URL.revokeObjectURL(objectUrl);
        const MAX_W = 1600;
        const scale = img.width > MAX_W ? MAX_W / img.width : 1;
        const canvas = document.createElement('canvas');
        canvas.width  = Math.round(img.width  * scale);
        canvas.height = Math.round(img.height * scale);
        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.88).split(',')[1]);
      };
      img.onerror = reject;
      img.src = objectUrl;
    });

    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 40,
          messages: [{
            role: 'user',
            content: [
              { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: base64 } },
              { type: 'text', text: 'Read the Vehicle Identification Number (VIN) in this photo. A VIN is exactly 17 characters, using only capital letters and digits (no I, O, or Q). Output ONLY the 17-character VIN with no spaces, dashes, or explanation. If you cannot read a VIN clearly, output UNREADABLE.' }
            ]
          }]
        })
      });

      const data = await res.json();
      if(data.error) throw new Error(data.error.message);
      const vin = data.content.map(b => b.text || '').join('').trim().toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');

      if(!vin || vin === 'UNREADABLE' || vin.length !== 17){
        statusEl.style.color = 'var(--rd)';
        statusEl.textContent = '‚ö† VIN unreadable ‚Äî try better lighting or enter manually';
        return;
      }

      vinEl.value = vin;
      updateEq(eqId, 'vin', vin);
      statusEl.style.color = 'var(--gr)';
      statusEl.textContent = '‚úì VIN scanned: ' + vin + ' ‚Äî tap üîç NHTSA to look up vehicle details';
      autosave();

    } catch(err){
      statusEl.style.color = 'var(--rd)';
      statusEl.textContent = '‚ö† Scan error: ' + err.message;
    }
  };

  input.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIGNATURES ‚Äî Fixed for mobile (pointer events + DPR scaling)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupSig(role){
  const canvas = document.getElementById('canvas'+role);
  const dpr = window.devicePixelRatio || 1;
  const displayW = canvas.offsetWidth || 400;
  const displayH = canvas.offsetHeight || 130;
  canvas.width  = displayW * dpr;
  canvas.height = displayH * dpr;
  canvas.style.width  = displayW + 'px';
  canvas.style.height = displayH + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.fillStyle = '#1A1A1A';
  ctx.fillRect(0, 0, displayW, displayH);
  ctx.strokeStyle = '#F2EDE4';
  ctx.lineWidth = 2.5;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  let drawing = false, lastX = 0, lastY = 0;
  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    if(e.clientX !== undefined) return {x:e.clientX-rect.left, y:e.clientY-rect.top};
    if(e.touches && e.touches[0]) return {x:e.touches[0].clientX-rect.left, y:e.touches[0].clientY-rect.top};
    return {x:0,y:0};
  }
  function onStart(e){
    e.preventDefault(); drawing=true;
    canvas.setPointerCapture && canvas.setPointerCapture(e.pointerId);
    const p=getPos(e); lastX=p.x; lastY=p.y;
  }
  function onMove(e){
    if(!drawing) return;
    e.preventDefault();
    const p=getPos(e);
    ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke();
    lastX=p.x; lastY=p.y;
    const st=document.getElementById('sigStatus'+role);
    st.textContent='‚úì Signed'; st.style.color='var(--gr)';
    sigData[role]=canvas.toDataURL();
  }
  function onEnd(){ drawing=false; }
  canvas.addEventListener('pointerdown',  onStart);
  canvas.addEventListener('pointermove',  onMove);
  canvas.addEventListener('pointerup',    onEnd);
  canvas.addEventListener('pointercancel',onEnd);
  canvas.addEventListener('pointerleave', onEnd);
  canvas.addEventListener('touchstart', function(e){e.preventDefault();},{passive:false});
  canvas.addEventListener('touchmove',  function(e){e.preventDefault();},{passive:false});
}

function clearSig(role){
  const canvas = document.getElementById('canvas'+role);
  const ctx = canvas.getContext('2d');
  // Clear respecting the DPR scale already applied
  ctx.setTransform(1,0,0,1,0,0);
  ctx.fillStyle = '#1A1A1A';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // Re-apply DPR scale
  const dpr = window.devicePixelRatio || 1;
  ctx.scale(dpr, dpr);
  ctx.strokeStyle = '#F2EDE4';
  ctx.lineWidth = 2.5;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  sigData[role] = null;
  const statusEl = document.getElementById('sigStatus'+role);
  statusEl.textContent = 'Not signed';
  statusEl.style.color = '';
  autosave();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT GENERATION ‚Äî MODAL + TWO PATHS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openGenerateModal(){
  document.getElementById('choiceModal').classList.add('show');
}

// ‚îÄ‚îÄ PATH A: Plain / As-Filled ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generatePlainReport(){
  document.getElementById('choiceModal').classList.remove('show');

  // If recording is still active, stop it cleanly first
  if(isRecording){
    isRecording = false;
    if(speechRecognition) speechRecognition.stop();
    const btn = document.getElementById('recordBtn');
    btn.classList.remove('recording');
    btn.innerHTML = '<div class="mic-dot"></div> Record Voice';
    // Small pause so final speech result event can fire
    await new Promise(r => setTimeout(r, 400));
    autosave();
  }

  // Gather all data
  const project   = v('project')   || 'N/A';
  const engineer  = v('engineer')  || 'N/A';
  const reportDate= v('reportDate')|| '';
  const shift     = v('shift')     || 'Day';
  const workers   = v('workers')   || 'N/A';
  const progress  = v('progress')  || 'N/A';
  const wind      = v('windSpeed') ? v('windSpeed') + ' mph' : 'N/A';
  const temp      = v('temp')      ? v('temp') + '¬∞F'       : 'N/A';
  const notes     = v('voiceText') || '(No notes entered)';
  const gpsStr    = gpsCoords ? gpsCoords.lat + ', ' + gpsCoords.lng + '  (¬±' + gpsCoords.acc + 'm)' : 'Not captured';

  const line52 = '‚ïê'.repeat(52);
  const line52d = '‚îÄ'.repeat(52);

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  let report = [
    'CONSTRUCTION DAILY REPORT',
    line52,
    'Project:  ' + project,
    'Date:     ' + reportDate + '     Shift: ' + shift,
    'Engineer: ' + engineer,
    'GPS:      ' + gpsStr,
    'Workers:  ' + workers + '   Progress: ' + progress + '%',
    'Weather:  ' + (weatherVal || 'N/A') + '   Wind: ' + wind + '   Temp: ' + temp,
    line52,
    ''
  ].join('\n');

  // ‚îÄ‚îÄ Sections (only toggled-on) ‚îÄ‚îÄ
  const sectionMap = {
    work:      'WORK COMPLETED',
    safety:    'SAFETY & HSE OBSERVATIONS',
    resources: 'RESOURCES & EQUIPMENT',
    delays:    'DELAYS & ISSUES',
    quality:   'QUALITY CONTROL & INSPECTIONS',
    plan:      'PLAN FOR TOMORROW'
  };

  // For plain report, site notes go under Work Completed (or all toggled sections)
  const activeKeys = [...selectedSections];
  if(activeKeys.length > 0){
    // Put notes under first active section, mark others as reported via notes
    const firstKey = activeKeys[0];
    report += '## ' + sectionMap[firstKey] + '\n';
    report += notes + '\n\n';
    activeKeys.slice(1).forEach(function(key){
      report += '## ' + sectionMap[key] + '\n';
      report += '(See field notes above / Not separately reported)\n\n';
    });
  } else {
    report += '## FIELD NOTES\n' + notes + '\n\n';
  }

  // ‚îÄ‚îÄ Equipment Register ‚îÄ‚îÄ
  report += line52d + '\n## EQUIPMENT REGISTER\n' + line52d + '\n';
  const eqFiltered = equipmentList.filter(function(e){ return e.name || e.make || e.plate || e.vin; });
  if(eqFiltered.length === 0){
    report += 'No equipment logged.\n';
  } else {
    eqFiltered.forEach(function(e, i){
      report += '\n  ' + (i+1) + '. Equipment ID: ' + (e.eqId || 'N/A') + '\n';
      report += '     Name/Type:    ' + e.name + '\n';
      if(e.isVehicle){
        report += '     Make/Model:   ' + (e.make || 'N/A') + '\n';
        report += '     License Plate:' + (e.plate || 'N/A') + '\n';
        if(e.vin) report += '     VIN:          ' + e.vin + '\n';
        if(e.nhtsaInfo){
          const n = e.nhtsaInfo;
          if(n.body)       report += '     Body Class:   ' + n.body + '\n';
          if(n.drive)      report += '     Drive Type:   ' + n.drive + '\n';
          if(n.fuel)       report += '     Fuel Type:    ' + n.fuel + '\n';
          if(n.gvwr)       report += '     GVWR:         ' + n.gvwr + '\n';
          if(n.axles)      report += '     No. of Axles: ' + n.axles + '\n';
          if(n.axleConfig) report += '     Axle Config:  ' + n.axleConfig + '\n';
        }
      }
      report += '     Status:       ' + e.status + '\n';
      if(e.status === 'Idle'){
        report += '     Idle Time:    ' + (e.idleHrs || 0) + 'h ' + (e.idleMins || 0) + 'm\n';
        if(e.idleReason) report += '     Idle Reason:  ' + e.idleReason + '\n';
      }
    });
  }
  report += '\n';

  // ‚îÄ‚îÄ Labor Compliance Register ‚îÄ‚îÄ
  report += line52d + '\n## LABOR COMPLIANCE REGISTER\n' + line52d + '\n';
  const lbFiltered = laborList.filter(function(l){ return l.name; });
  if(lbFiltered.length === 0){
    report += 'No workers logged.\n';
  } else {
    // Header row
    report += '\n  #   Legal Full Name              Role / Trade         Company\n';
    report += '  ' + '‚îÄ'.repeat(74) + '\n';
    lbFiltered.forEach(function(l, i){
      const num  = String(i+1).padEnd(3);
      const name = (l.name || '').padEnd(30).substring(0,30);
      const role = (l.role || 'N/A').padEnd(20).substring(0,20);
      const comp = l.company || 'N/A';
      report += '  ' + num + ' ' + name + ' ' + role + ' ' + comp + '\n';
    });
    report += '\n  Total workers on site: ' + lbFiltered.length + '\n';
  }
  report += '\n';

  // ‚îÄ‚îÄ Photo Log ‚îÄ‚îÄ
  if(photos.length > 0){
    report += line52d + '\n## PHOTO LOG\n' + line52d + '\n';
    photos.forEach(function(p, i){
      const cat = p.category.charAt(0).toUpperCase() + p.category.slice(1);
      const ts  = p.timestamp ? '  [' + p.timestamp + ']' : '';
      report += '\n  Photo ' + (i+1) + ' [' + cat + ']' + ts + ': ' + (p.caption || '(No caption)') + '\n';
    });
    report += '\n';
  }

  // ‚îÄ‚îÄ Sign-Off Block ‚îÄ‚îÄ
  report += line52d + '\nSIGNATURES & SIGN-OFF\n' + line52d + '\n\n';
  report += 'Field Inspector (Owner):\n';
  report += '  Name: ' + (v('inspectorName') || '________________________________') + '\n';
  report += '  Date: ' + reportDate + '\n';
  report += '  Signature: [See digital signature below]\n\n';
  report += 'Contractor Superintendent:\n';
  report += '  Name: ' + (v('superintendentName') || '________________________________') + '\n';
  report += '  Date: ' + reportDate + '\n';
  report += '  Signature: [See digital signature below]\n\n';
  report += line52 + '\n';
  report += 'Report generated by SiteLog AI  ¬∑  ' + new Date().toLocaleString() + '\n';

  // Render & email
  renderReport(report, false);
  if(emailTo) sendEmailAPI(report);
}

// ‚îÄ‚îÄ PATH B: AI-Generated ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateAIReport(){
  document.getElementById('choiceModal').classList.remove('show');

  if(!apiKey){
    document.getElementById('noKeyWarn').classList.add('show');
    document.getElementById('noKeyWarn').scrollIntoView({behavior:'smooth', block:'center'});
    showStatus('‚ö† API key required for AI report. Scroll up to Configuration to add it, or choose "As-Filled Report".', false);
    setTimeout(hideStatus, 6000);
    return;
  }

  // If recording is still in progress, stop it cleanly first
  if(isRecording){
    isRecording = false;
    if(speechRecognition) speechRecognition.stop();
    const btn = document.getElementById('recordBtn');
    btn.classList.remove('recording');
    btn.innerHTML = '<div class="mic-dot"></div> Record Voice';
    await new Promise(r => setTimeout(r, 400));
    autosave();
  }

  // Allow generation even with no typed notes ‚Äî voice transcript may be the only input,
  // or the inspector may be relying entirely on equipment/labor/photo data.
  const notes = v('voiceText').trim();
  const hasData = notes || equipmentList.some(e=>e.name) || laborList.some(l=>l.name) || photos.length > 0;
  if(!hasData){
    if(!confirm('No notes, equipment, labor, or photos have been entered. Generate a report anyway?')) return;
  }

  if(!navigator.onLine){
    saveToQueue();
    showStatus('‚ö° Offline ‚Äî AI report queued. Will generate & email when internet is restored.', false);
    return;
  }

  showStatus('Claude AI is writing your report‚Ä¶', true);
  document.getElementById('generateBtn').disabled = true;

  try {
    const aiText = await callAI(buildPrompt());
    renderReport(aiText, true);
    if(emailTo) await sendEmailAPI(document.getElementById('reportContent').textContent);
  } catch(err){
    showStatus('‚úó AI Error: ' + err.message, false);
    setTimeout(hideStatus, 5000);
  }

  document.getElementById('generateBtn').disabled = false;
  hideStatus();
}

function buildPrompt(){
  const project = v('project')||'N/A', engineer = v('engineer')||'N/A';
  const reportDate = v('reportDate'), workers = v('workers')||'N/A';
  const progress = v('progress')||'N/A', shift = v('shift')||'Day';
  const wind = v('windSpeed') ? v('windSpeed')+' mph' : 'N/A';
  const temp = v('temp') ? v('temp')+'¬∞F' : 'N/A';
  const notes = v('voiceText');
  
  const langMap = {en:'English',es:'Spanish',zh:'Chinese (Mandarin)',vi:'Vietnamese'};
  const langNote = inputLang !== 'en' ? `\n\nIMPORTANT: The site notes below are written in ${langMap[inputLang]}. Translate to English and use in the report.` : '';
  
  const gpsStr = gpsCoords ? `${gpsCoords.lat}, ${gpsCoords.lng}` : 'Not available';
  
  // Equipment section
  const eqLines = equipmentList.filter(e=>e.name||e.make||e.plate||e.vin).map(e=>{
    let line = `  - ID: ${e.eqId||'N/A'} | ${e.name} | Status: ${e.status}`;
    if(e.isVehicle){
      if(e.make)  line += ` | Vehicle: ${e.make}`;
      if(e.plate) line += ` | Plate: ${e.plate}`;
      if(e.vin)   line += ` | VIN: ${e.vin}`;
      if(e.nhtsaInfo){
        const n = e.nhtsaInfo;
        if(n.body)       line += ` | Body: ${n.body}`;
        if(n.drive)      line += ` | Drive: ${n.drive}`;
        if(n.fuel)       line += ` | Fuel: ${n.fuel}`;
        if(n.gvwr)       line += ` | GVWR: ${n.gvwr}`;
        if(n.axles)      line += ` | Axles: ${n.axles}`;
        if(n.axleConfig) line += ` | Axle Config: ${n.axleConfig}`;
      }
    }
    if(e.status==='Idle') line += ` | Idle: ${e.idleHrs||0}h ${e.idleMins||0}m${e.idleReason?' ('+e.idleReason+')':''}`;
    return line;
  }).join('\n');
  
  // Labor section
  const lbLines = laborList.filter(l=>l.name).map(l=>`  - ${l.name} | ${l.role||'N/A'} | ${l.company||'N/A'}`).join('\n');
  
  const sections = [...selectedSections];
  const sectionMap = {work:'Work Completed',safety:'Safety & HSE Observations',resources:'Resources & Equipment',delays:'Delays & Issues',quality:'Quality Control & Inspections',plan:'Plan for Tomorrow'};
  const selectedLabels = sections.map(s=>sectionMap[s]).join(', ');
  
  return `You are an experienced construction site engineer. Write a formal, professional Construction Daily Report.${langNote}

‚ïê‚ïê‚ïê PROJECT HEADER ‚ïê‚ïê‚ïê
Project: ${project}
Date: ${reportDate}
Shift: ${shift}
Field Engineer: ${engineer}
GPS Location: ${gpsStr}
Workers on Site: ${workers}
Overall Progress: ${progress}%
Weather: ${weatherVal||'N/A'}
Wind Speed: ${wind}
Temperature: ${temp}

‚ïê‚ïê‚ïê EQUIPMENT ON SITE ‚ïê‚ïê‚ïê
${eqLines||'None logged'}

‚ïê‚ïê‚ïê LABOR ON SITE (Compliance Log) ‚ïê‚ïê‚ïê
${lbLines||'None logged'}

‚ïê‚ïê‚ïê FIELD NOTES ‚ïê‚ïê‚ïê
"""
${notes}
"""

‚ïê‚ïê‚ïê INSTRUCTIONS ‚ïê‚ïê‚ïê
Write a professional daily report with these sections: ${selectedLabels}.
Also include a formal "Equipment Register" section summarizing all equipment above (for vehicles include plate, VIN, GVWR, and axle count; note any idle equipment with hours and reason).
Also include a "Labor Compliance Register" section listing all workers above in a clear format.
Each section uses a ## header. Write in formal construction industry language. Be factual and concise. If info is missing write "Not reported." End with a sign-off block.`;
}

async function callAI(prompt){
  const res = await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",
    headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
    body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2000,messages:[{role:"user",content:prompt}]})
  });
  const data = await res.json();
  if(data.error) throw new Error(data.error.message);
  return data.content.map(b=>b.text||'').join('');
}

function renderReport(text, isAI){
  const project = v('project')||'Project';
  const engineer = v('engineer')||'N/A';
  const reportDate = v('reportDate');
  const progress = v('progress')||'N/A';
  const workers = v('workers')||'N/A';
  const gpsStr = gpsCoords ? gpsCoords.lat + ', ' + gpsCoords.lng : 'N/A';

  let fullText;
  if(isAI){
    // AI path: prepend the standard header block to AI-generated body
    const header = [
      'CONSTRUCTION DAILY REPORT',
      '‚ïê'.repeat(52),
      'Project:  ' + project,
      'Date:     ' + reportDate + '     Shift: ' + (v('shift')||'Day'),
      'Engineer: ' + engineer,
      'GPS:      ' + gpsStr,
      'Workers:  ' + workers + '   Progress: ' + progress + '%',
      'Weather:  ' + (weatherVal||'N/A') + '   Wind: ' + (v('windSpeed')||'N/A') + ' mph   Temp: ' + (v('temp')||'N/A') + '¬∞F',
      '‚ïê'.repeat(52),
      ''
    ].join('\n');

    let photoLog = '';
    if(photos.length > 0){
      photoLog = '\n\n## Photo Log\n';
      photos.forEach(function(p,i){
        photoLog += 'Photo '+(i+1)+' ['+p.category.charAt(0).toUpperCase()+p.category.slice(1)+']: '+(p.caption||'(No caption)')+'\n';
      });
    }

    const sigBlock = '\n\n' + '‚îÄ'.repeat(52) + '\nSIGNATURES\n' + '‚îÄ'.repeat(52) +
      '\nField Inspector (Owner): ' + (v('inspectorName')||'___________________') + '    Date: ' + reportDate +
      '\n\nContractor Superintendent: ' + (v('superintendentName')||'___________________') + '    Date: ' + reportDate + '\n';

    fullText = header + text + photoLog + sigBlock;
  } else {
    // Plain path: text is already the fully assembled report string
    fullText = text;
  }

  document.getElementById('reportContent').textContent = fullText;

  // Photo thumbnails in report
  const pa = document.getElementById('reportPhotoArea');
  pa.innerHTML = '';
  if(photos.length > 0){
    const grid = document.createElement('div');
    grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:16px;border-top:1px solid var(--dk4);padding-top:16px;';
    const title = document.createElement('div');
    title.style.cssText = 'grid-column:1/-1;font-family:"Bebas Neue",sans-serif;font-size:18px;letter-spacing:1.5px;color:var(--y);';
    title.textContent = `Photo Log ‚Äî ${photos.length} Images`;
    grid.appendChild(title);
    photos.forEach((p,i)=>{
      const card = document.createElement('div');
      card.style.cssText = 'background:var(--dk3);border-radius:6px;overflow:hidden;border:1px solid var(--dk4);';
      let gpsTag = '';
      if(p.gps && p.gps.lat){
        const lat = parseFloat(p.gps.lat).toFixed(6);
        const lng = parseFloat(p.gps.lng).toFixed(6);
        const url = `https://maps.apple.com/?ll=${lat},${lng}&z=18&t=h`;
        gpsTag = `<a href="${url}" target="_blank" style="display:block;font-size:9px;color:#4A9ECD;font-family:monospace;margin-top:2px;text-decoration:none;word-break:break-all;">üìç ${lat}, ${lng}</a>`;
      }
      card.innerHTML = `<img src="${p.dataUrl}" style="width:100%;height:100px;object-fit:cover;display:block;"><div style="padding:6px 8px;"><div style="font-size:9px;color:var(--or);font-weight:700;text-transform:uppercase;">${p.category}</div><div style="font-size:10px;color:var(--lt);line-height:1.3;margin-top:2px;">Photo ${i+1}: ${p.caption||'(No caption)'}</div>${gpsTag}</div>`;
      grid.appendChild(card);
    });
    pa.appendChild(grid);
  }
  
  // Signatures in report
  const sa = document.getElementById('reportSigArea');
  sa.innerHTML = '';
  const sigGrid = document.createElement('div');
  sigGrid.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:16px;border-top:1px solid var(--dk4);padding-top:16px;';
  ['Inspector','Superintendent'].forEach(role=>{
    const box = document.createElement('div');
    const label = role==='Inspector' ? 'Owner / Field Inspector' : 'Contractor Superintendent';
    const name = role==='Inspector' ? v('inspectorName') : v('superintendentName');
    box.innerHTML = `<div style="font-size:11px;font-weight:700;color:var(--y);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">${label}</div><div style="font-size:12px;color:var(--mu);margin-bottom:6px;">${name||'Name not provided'}</div>`;
    if(sigData[role]){
      const img = document.createElement('img');
      img.src = sigData[role];
      img.style.cssText = 'width:100%;border:1px solid var(--dk4);border-radius:4px;background:var(--dk3);';
      box.appendChild(img);
    } else {
      const blank = document.createElement('div');
      blank.style.cssText = 'border:1px dashed var(--dk4);border-radius:4px;height:80px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--mu);';
      blank.textContent = 'Not signed';
      box.appendChild(blank);
    }
    sigGrid.appendChild(box);
  });
  sa.appendChild(sigGrid);
  
  renderReportLogoBar();
  document.getElementById('reportOut').classList.add('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMAIL  ‚Äî clean text + full HTML attachment
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/* Strip markdown-style symbols and box-drawing chars so the
   plain-text mailto body looks clean in every email client. */
function cleanForEmail(raw){
  return raw
    // Remove ## section headers ‚Äî keep the label, strip the hashes
    .replace(/^##\s+/gm, '')
    // Replace box-drawing divider lines (‚ïê‚ïê‚ïê, ‚îÄ‚îÄ‚îÄ) with a plain dashed line
    .replace(/[‚ïê‚îÄ]{4,}/g, '--------------------------------------------')
    // Replace any remaining box-drawing / special Unicode chars
    .replace(/[^\x00-\x7F]/g, function(c){
      // Allow common accented letters through; strip true box-drawing
      const code = c.charCodeAt(0);
      if(code >= 0x2500 && code <= 0x257F) return '-'; // box drawing block
      if(code === 0x2550 || code === 0x2551) return '='; // double box
      return c; // keep everything else (accented letters, etc.)
    })
    // Collapse 3+ consecutive blank lines to 2
    .replace(/\n{3,}/g, '\n\n')
    .trim();
}

/* Build a fully self-contained HTML report with embedded
   base64 photos and signature images ‚Äî suitable for download
   and email attachment. */
function buildHTMLReport(textBody){
  const project    = v('project')  || 'Project';
  const reportDate = v('reportDate') || '';
  const engineer   = v('engineer') || 'N/A';

  // Photo rows ‚Äî full width, stacked, print-ready
  let photoHTML = '';
  if(photos.length > 0){
    photoHTML = '<h2 style="color:#c8890a;border-bottom:2px solid #c8890a;padding-bottom:6px;margin-top:32px;">Photo Log</h2>';
    photos.forEach(function(p, i){
      const cat = p.category.charAt(0).toUpperCase() + p.category.slice(1);
      const ts  = p.timestamp || '';

      // GPS map link ‚Äî coordinates as label, opens Apple Maps (iOS) / Google Maps (others)
      let gpsHTML = '';
      if(p.gps && p.gps.lat && p.gps.lng){
        const lat = parseFloat(p.gps.lat).toFixed(6);
        const lng = parseFloat(p.gps.lng).toFixed(6);
        const acc = p.gps.acc ? ' &plusmn;' + Math.round(p.gps.acc) + 'm' : '';
        const mapsUrl = 'https://maps.apple.com/?ll=' + lat + ',' + lng + '&z=18&t=h';
        gpsHTML = '<a href="' + mapsUrl + '" target="_blank" rel="noopener" ' +
          'style="display:inline-block;font-family:monospace;font-size:11px;color:#1a73e8;' +
          'text-decoration:none;margin-top:5px;padding:3px 8px;background:#f0f7ff;' +
          'border:1px solid #c5d8f5;border-radius:4px;">' +
          'üìç ' + lat + ', ' + lng + acc + '</a>';
      }

      photoHTML += '<div style="width:100%;margin-bottom:32px;page-break-inside:avoid;border:1px solid #ddd;border-radius:6px;overflow:hidden;">';
      photoHTML += '<img src="' + p.dataUrl + '" style="width:100%;display:block;max-width:100%;">';
      photoHTML += '<div style="padding:10px 14px;background:#fafafa;border-top:1px solid #eee;">';
      photoHTML += '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px;">';
      photoHTML += '<div>';
      photoHTML += '<span style="font-size:11px;font-weight:700;text-transform:uppercase;color:#c8890a;letter-spacing:0.5px;">' + cat + '</span>';
      photoHTML += '&nbsp;&nbsp;<span style="font-size:12px;color:#555;font-weight:600;">Photo ' + (i+1) + '</span>';
      photoHTML += '</div>';
      if(ts) photoHTML += '<div style="font-size:11px;color:#888;">üïê ' + ts + '</div>';
      photoHTML += '</div>';
      if(gpsHTML) photoHTML += gpsHTML;
      photoHTML += '<div style="font-size:13px;color:#222;margin-top:6px;line-height:1.5;">' + (p.caption || '<em style="color:#999;">No caption</em>') + '</div>';
      photoHTML += '</div></div>';
    });
  }

  // Signature rows
  let sigHTML = '<h2 style="color:#c8890a;border-bottom:2px solid #c8890a;padding-bottom:6px;">Signatures &amp; Sign-Off</h2>';
  sigHTML += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">';
  ['Inspector','Superintendent'].forEach(function(role){
    const label = role === 'Inspector' ? 'Owner / Field Inspector' : 'Contractor Superintendent';
    const name  = role === 'Inspector' ? (v('inspectorName') || 'Not provided') : (v('superintendentName') || 'Not provided');
    sigHTML += '<div style="border:1px solid #ddd;border-radius:6px;padding:14px;">';
    sigHTML += '<div style="font-size:11px;font-weight:700;text-transform:uppercase;color:#c8890a;margin-bottom:6px;">' + label + '</div>';
    sigHTML += '<div style="font-size:13px;margin-bottom:10px;"><strong>' + name + '</strong></div>';
    if(sigData[role]){
      sigHTML += '<img src="' + sigData[role] + '" style="width:100%;max-height:100px;object-fit:contain;border:1px solid #eee;border-radius:4px;background:#f9f9f9;">';
    } else {
      sigHTML += '<div style="height:70px;border:1px dashed #ccc;border-radius:4px;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;">Not signed</div>';
    }
    sigHTML += '<div style="font-size:11px;color:#666;margin-top:6px;">Date: ' + reportDate + '</div>';
    sigHTML += '</div>';
  });
  sigHTML += '</div>';

  // Convert the plain text body into readable HTML paragraphs
  const bodyHTML = textBody
    .split('\n')
    .map(function(line){
      line = line
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      // Section headers
      if(/^##\s/.test(line)){
        return '<h2 style="color:#c8890a;border-bottom:1px solid #e8d5a0;padding-bottom:4px;margin-top:24px;">' + line.replace(/^##\s+/,'') + '</h2>';
      }
      // Divider lines
      if(/^[‚ïê‚îÄ=\-]{10,}$/.test(line)){
        return '<hr style="border:none;border-top:1px solid #ddd;margin:12px 0;">';
      }
      if(line.trim() === '') return '<br>';
      return '<p style="margin:0 0 4px;line-height:1.6;">' + line + '</p>';
    })
    .join('\n');

  // Logo bar ‚Äî only rendered if at least one logo was uploaded
  const hasLogos = reportLogos.left || reportLogos.center || reportLogos.right;
  const logoBarHTML = hasLogos ? `
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:center;margin-bottom:18px;padding-bottom:14px;border-bottom:2px solid #c8890a;">
  <div style="text-align:left;">${reportLogos.left  ? '<img src="'+reportLogos.left +'" style="max-height:60px;max-width:150px;object-fit:contain;">' : ''}</div>
  <div style="text-align:center;">${reportLogos.center? '<img src="'+reportLogos.center+'" style="max-height:60px;max-width:150px;object-fit:contain;">' : ''}</div>
  <div style="text-align:right;">${reportLogos.right ? '<img src="'+reportLogos.right +'" style="max-height:60px;max-width:150px;object-fit:contain;">' : ''}</div>
</div>` : '';

  return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Site Daily Report ‚Äì ${project} ‚Äì ${reportDate}</title>
<style>
  body{font-family:Arial,sans-serif;font-size:13px;color:#222;max-width:900px;margin:0 auto;padding:24px;}
  h1{font-size:22px;color:#1a1a1a;border-bottom:3px solid #c8890a;padding-bottom:10px;margin-top:8px;}
  h2{font-size:15px;color:#c8890a;}
  .header-block{background:#f5f0e8;border-left:4px solid #c8890a;padding:14px 18px;border-radius:4px;margin-bottom:20px;font-size:13px;line-height:1.8;}
  .footer{font-size:11px;color:#999;border-top:1px solid #eee;padding-top:12px;margin-top:24px;}
  @media print {
    body{max-width:100%;padding:0;margin:0;}
    .header-block{background:#f5f0e8!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
    img{max-width:100%!important;page-break-inside:avoid;}
    h2{page-break-after:avoid;}
    div{page-break-inside:avoid;}
  }
</style>
</head>
<body>
${logoBarHTML}
<h1>Construction Daily Report</h1>
<div class="header-block">
  <strong>Project:</strong> ${project} &nbsp;|&nbsp;
  <strong>Date:</strong> ${reportDate} &nbsp;|&nbsp;
  <strong>Engineer:</strong> ${engineer}<br>
  <strong>GPS:</strong> ${gpsCoords ? gpsCoords.lat+', '+gpsCoords.lng : 'Not captured'} &nbsp;|&nbsp;
  <strong>Weather:</strong> ${weatherVal||'N/A'} &nbsp;|&nbsp;
  <strong>Wind:</strong> ${v('windSpeed')||'N/A'} mph &nbsp;|&nbsp;
  <strong>Temp:</strong> ${v('temp')||'N/A'}¬∞F
</div>
${bodyHTML}
${photoHTML}
${sigHTML}
<div class="footer">Generated by SiteLog AI &nbsp;¬∑&nbsp; ${new Date().toLocaleString()}</div>
</body>
</html>`;
}

/* Trigger a download of the full HTML report (with embedded photos + sigs) */
function downloadHTMLReport(htmlContent, project, reportDate){
  const blob = new Blob([htmlContent], {type:'text/html'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'SiteReport_' + (project||'report').replace(/\s+/g,'_') + '_' + (reportDate||'today') + '.html';
  document.body.appendChild(a);
  a.click();
  setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); }, 1000);
}

/* Main send function ‚Äî cleans text for mailto, builds HTML for download,
   opens mail client with clean body, then offers HTML download. */
async function sendEmailAPI(rawReportText){
  const project    = v('project')  || 'Project';
  const reportDate = v('reportDate') || '';

  // 1. Clean the text for plain-text email body
  const cleanText = cleanForEmail(rawReportText);

  // Note about photos/signatures appended to email body
  const photoNote  = photos.length > 0
    ? '\n\n[' + photos.length + ' site photo(s) included ‚Äî see HTML attachment]\n'
    : '';
  const sigNote    = (sigData.Inspector || sigData.Superintendent)
    ? '[Digital signatures captured ‚Äî see HTML attachment]\n'
    : '';
  const attachNote = (photos.length > 0 || sigData.Inspector || sigData.Superintendent)
    ? '\n--------------------------------------------\nNOTE: This email includes an HTML attachment\n(SiteReport_*.html) with embedded photos and\nsignature images. Please open and attach it.\n--------------------------------------------'
    : '';

  const emailBody = cleanText + photoNote + sigNote + attachNote;

  // 2. Build + auto-download the self-contained HTML report
  const htmlReport = buildHTMLReport(rawReportText);
  downloadHTMLReport(htmlReport, project, reportDate);

  // 3. Open the mailto with the clean text body
  const subject = encodeURIComponent('Site Daily Report ‚Äì ' + project + ' ‚Äì ' + reportDate);
  // mailto body has a 2000-char practical limit in most clients
  const bodyForMailto = emailBody.length > 2000
    ? emailBody.substring(0, 1950) + '\n\n[Report continues in HTML attachment]'
    : emailBody;
  const mailto = 'mailto:' + emailTo + '?subject=' + subject + '&body=' + encodeURIComponent(bodyForMailto);
  window.open(mailto, '_blank');

  showStatus('‚úâ Email client opened ¬∑ HTML report downloaded ‚Äî attach the file to your email', false);
  setTimeout(hideStatus, 5000);
}

function sendEmail(){
  const reportText = document.getElementById('reportContent').textContent;
  if(!emailTo){ alert('No email address set. Add it in Configuration and save.'); return; }
  sendEmailAPI(reportText);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OFFLINE QUEUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveToQueue(){
  const entry = {
    ts: Date.now(),
    prompt: buildPrompt(),
    emailTo,
    project: v('project'),
    date: v('reportDate')
  };
  offlineQueue.push(entry);
  localStorage.setItem('sitelog_queue', JSON.stringify(offlineQueue));
  updateQueueBadge();
  saveDraft();
}

async function processQueue(){
  if(!navigator.onLine || offlineQueue.length===0 || !apiKey) return;
  showStatus(`Processing ${offlineQueue.length} queued report(s)...`, true);
  const processed = [];
  for(const entry of offlineQueue){
    try {
      const text = await callAI(entry.prompt);
      if(entry.emailTo){
        const subject = encodeURIComponent(`[Queued] Site Daily Report ‚Äì ${entry.project} ‚Äì ${entry.date}`);
        const body = encodeURIComponent(text.substring(0,1900));
        window.open(`mailto:${entry.emailTo}?subject=${subject}&body=${body}`, '_blank');
      }
      processed.push(entry.ts);
    } catch(e){ console.error('Queue error',e); }
  }
  offlineQueue = offlineQueue.filter(e => !processed.includes(e.ts));
  localStorage.setItem('sitelog_queue', JSON.stringify(offlineQueue));
  updateQueueBadge();
  hideStatus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyReport(){
  navigator.clipboard.writeText(document.getElementById('reportContent').textContent).then(()=>{
    const btn = event.target; btn.textContent='‚úì Copied!';
    setTimeout(()=>btn.textContent='‚éò Copy Text',2000);
  });
}

function downloadReport(){
  const rawText = document.getElementById('reportContent').textContent;
  const project = v('project') || 'report';
  const date    = v('reportDate') || 'today';
  // Download the rich HTML version (includes photos + sigs)
  const htmlReport = buildHTMLReport(rawText);
  downloadHTMLReport(htmlReport, project, date);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function v(id){ return document.getElementById(id)?.value || ''; }
function set(id, val){ const el=document.getElementById(id); if(el) el.value=val||''; }
function showStatus(msg, spin){
  const bar = document.getElementById('statusBar');
  bar.classList.add('show');
  document.getElementById('statusText').textContent = msg;
  bar.querySelector('.spinner').style.display = spin ? 'block' : 'none';
}
function hideStatus(){ document.getElementById('statusBar').classList.remove('show'); }
</script>
</body>
</html>
